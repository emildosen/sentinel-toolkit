{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Home","text":""},{"location":"#microsoft-sentinel-tools","title":"Microsoft Sentinel Tools","text":"<p>A collection of KQL queries and Azure Workbooks for Microsoft Sentinel.</p> <ul> <li> <p> Workbooks</p> <p>Pre-built Azure Workbooks for security monitoring, MFA analysis, sign-in investigation, and more.</p> <p> Browse Workbooks</p> </li> <li> <p> KQL Queries</p> <p>Ready-to-use Kusto Query Language queries for alerting and hunting in Microsoft Sentinel.</p> <p> Browse Queries</p> </li> </ul>"},{"location":"#quick-start","title":"Quick Start","text":""},{"location":"#installing-a-workbook","title":"Installing a Workbook","text":"<ol> <li>Navigate to Microsoft Sentinel &gt; Workbooks &gt; Add workbook</li> <li>Click Edit then Advanced editor</li> <li>Copy the contents of the desired <code>template.json</code> file</li> <li>Paste into the editor and click Apply</li> <li>Save the workbook</li> </ol>"},{"location":"#using-a-kql-query","title":"Using a KQL Query","text":"<ol> <li>Navigate to Investigation &amp; response &gt; Hunting &gt; Advanced hunting</li> <li>Copy the desired <code>.kql</code> query</li> <li>Paste into the query editor</li> <li>Adjust parameters as needed and run query</li> </ol>"},{"location":"#license","title":"License","text":"<p>This project is licensed under the MIT License.</p>"},{"location":"queries/","title":"Queries","text":""},{"location":"queries/#kql-queries","title":"KQL Queries","text":"<p>Ready-to-use Kusto Query Language queries organized by category.</p>"},{"location":"queries/#alerts","title":"Alerts","text":"<ul> <li>Emergency Access Account Sign-in</li> </ul>"},{"location":"queries/alerts/emergency-access-account-signin/","title":"Emergency Access Account Sign-in","text":""},{"location":"queries/alerts/emergency-access-account-signin/#emergency-access-account-sign-in","title":"Emergency Access Account Sign-in","text":"<p>Alert when an emergency access (break-glass) account has been used. Run every 5 minutes with a 5-minute lookback.</p>"},{"location":"queries/alerts/emergency-access-account-signin/#purpose","title":"Purpose","text":"<p>Detects sign-ins from emergency access accounts which should only be used in break-glass scenarios. Any use should trigger immediate investigation.</p>"},{"location":"queries/alerts/emergency-access-account-signin/#configuration","title":"Configuration","text":"<p>Update the <code>EmergencyAccessAccounts</code> list with your organization's emergency account UPNs.</p>"},{"location":"queries/alerts/emergency-access-account-signin/#query","title":"Query","text":"<pre><code>let EmergencyAccessAccounts = dynamic([\"emergencyaccess1@example.com\", \"emergencyaccess2@example.com\"]);\nSigninLogs\n| where UserPrincipalName in~ (EmergencyAccessAccounts)\n| project\n    TimeGenerated,\n    UserPrincipalName,\n    UserId,\n    IPAddress,\n    Location = strcat(LocationDetails.city, \", \", LocationDetails.countryOrRegion),\n    AppDisplayName,\n    ResultType,\n    ResultDescription,\n    DeviceDetail,\n    ConditionalAccessStatus\n</code></pre>"},{"location":"workbooks/","title":"Workbooks","text":""},{"location":"workbooks/#workbooks","title":"Workbooks","text":""},{"location":"workbooks/#alerts-dashboard","title":"Alerts Dashboard","text":""},{"location":"workbooks/#mfa-coverage-analysis","title":"MFA Coverage Analysis","text":""},{"location":"workbooks/#sign-in-analyzer","title":"Sign-in Analyzer","text":""},{"location":"workbooks/#user-compromise-investigation","title":"User Compromise Investigation","text":""},{"location":"workbooks/alerts%20dashboard/","title":"Alerts Dashboard","text":""},{"location":"workbooks/alerts%20dashboard/#alerts-dashboard","title":"Alerts Dashboard","text":"<p>Sentinel workbook for monitoring alerts and incidents.</p> <p></p>"},{"location":"workbooks/alerts%20dashboard/#sections","title":"Sections","text":"<ul> <li>Overview: Open/closed incidents, high severity count, alerts, avg close time</li> <li>Open Incidents: Table of current open incidents</li> <li>Alerts: Volume trend, severity breakdown, product breakdown, top rules, recent alerts</li> <li>Entities: Top accounts, hosts, and IPs appearing in alerts</li> </ul>"},{"location":"workbooks/alerts%20dashboard/#requirements","title":"Requirements","text":"<ul> <li>SecurityIncident table</li> <li>SecurityAlert table</li> </ul>"},{"location":"workbooks/alerts%20dashboard/#template","title":"Template","text":"<pre><code>{\n  \"version\": \"Notebook/1.0\",\n  \"items\": [\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"# Alerts Dashboard\\n---\"\n      },\n      \"name\": \"title\"\n    },\n    {\n      \"type\": 9,\n      \"content\": {\n        \"version\": \"KqlParameterItem/1.0\",\n        \"parameters\": [\n          {\n            \"version\": \"KqlParameterItem/1.0\",\n            \"name\": \"TimeRange\",\n            \"type\": 4,\n            \"isRequired\": true,\n            \"typeSettings\": {\n              \"selectableValues\": [\n                { \"durationMs\": 3600000 },\n                { \"durationMs\": 14400000 },\n                { \"durationMs\": 86400000 },\n                { \"durationMs\": 259200000 },\n                { \"durationMs\": 604800000 },\n                { \"durationMs\": 1209600000 },\n                { \"durationMs\": 2592000000 }\n              ],\n              \"allowCustom\": true\n            },\n            \"value\": { \"durationMs\": 604800000 },\n            \"label\": \"Time Range\"\n          }\n        ],\n        \"style\": \"pills\"\n      },\n      \"name\": \"parameters\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SecurityIncident\\n| summarize arg_max(TimeGenerated, *) by IncidentNumber\\n| where Status != \\\"Closed\\\"\\n| summarize Count = count()\",\n              \"size\": 4,\n              \"title\": \"Open Incidents\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": { \"columnMatch\": \"Count\", \"formatter\": 12, \"formatOptions\": { \"palette\": \"redBright\" } },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"16\",\n            \"name\": \"open-incidents\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SecurityIncident\\n| summarize arg_max(TimeGenerated, *) by IncidentNumber\\n| where Status != \\\"Closed\\\" and Severity == \\\"High\\\"\\n| summarize Count = count()\",\n              \"size\": 4,\n              \"title\": \"High Severity\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": { \"columnMatch\": \"Count\", \"formatter\": 12, \"formatOptions\": { \"palette\": \"magenta\" } },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"16\",\n            \"name\": \"high-severity\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SecurityAlert\\n| summarize arg_max(TimeGenerated, *) by SystemAlertId\\n| summarize Count = count()\",\n              \"size\": 4,\n              \"title\": \"Alerts\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": { \"columnMatch\": \"Count\", \"formatter\": 12, \"formatOptions\": { \"palette\": \"orange\" } },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"16\",\n            \"name\": \"total-alerts\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SecurityIncident\\n| summarize arg_max(TimeGenerated, *) by IncidentNumber\\n| where Status == \\\"Closed\\\"\\n| summarize Count = count()\",\n              \"size\": 4,\n              \"title\": \"Closed\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": { \"columnMatch\": \"Count\", \"formatter\": 12, \"formatOptions\": { \"palette\": \"green\" } },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"16\",\n            \"name\": \"closed-incidents\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SecurityIncident\\n| summarize arg_max(TimeGenerated, *) by IncidentNumber\\n| where Status == \\\"Closed\\\" and isnotempty(ClosedTime)\\n| extend ResponseTime = datetime_diff('minute', ClosedTime, CreatedTime)\\n| summarize MTTR = avg(ResponseTime)\\n| project MTTR = iff(isnan(MTTR), \\\"N/A\\\", strcat(round(MTTR / 60, 1), \\\" hrs\\\"))\",\n              \"size\": 4,\n              \"title\": \"Avg Close Time\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": { \"columnMatch\": \"MTTR\", \"formatter\": 12, \"formatOptions\": { \"palette\": \"blue\" } },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"16\",\n            \"name\": \"mttr\"\n          }\n        ]\n      },\n      \"name\": \"overview-tiles\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SecurityIncident\\n| summarize arg_max(TimeGenerated, *) by IncidentNumber\\n| where Status != \\\"Closed\\\"\\n| extend Age = datetime_diff('hour', now(), CreatedTime)\\n| project\\n    Title,\\n    Severity,\\n    Status,\\n    Owner = tostring(coalesce(Owner.assignedTo, \\\"Unassigned\\\")),\\n    CreatedTime,\\n    Age = strcat(Age, \\\"h\\\")\\n| order by case(Severity == \\\"High\\\", 1, Severity == \\\"Medium\\\", 2, Severity == \\\"Low\\\", 3, 4), CreatedTime desc\\n| take 10\",\n              \"size\": 2,\n              \"title\": \"Open Incidents\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"table\",\n              \"gridSettings\": {\n                \"formatters\": [\n                  { \"columnMatch\": \"Severity\", \"formatter\": 18, \"formatOptions\": { \"thresholdsOptions\": \"colors\", \"thresholdsGrid\": [\n                    { \"operator\": \"==\", \"thresholdValue\": \"High\", \"representation\": \"redBright\", \"text\": \"{0}{1}\" },\n                    { \"operator\": \"==\", \"thresholdValue\": \"Medium\", \"representation\": \"orange\", \"text\": \"{0}{1}\" },\n                    { \"operator\": \"==\", \"thresholdValue\": \"Low\", \"representation\": \"yellow\", \"text\": \"{0}{1}\" },\n                    { \"operator\": \"Default\", \"representation\": \"gray\", \"text\": \"{0}{1}\" }\n                  ]}}\n                ]\n              }\n            },\n            \"name\": \"open-incidents-list\"\n          }\n        ]\n      },\n      \"name\": \"incidents-row\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## Alerts\"\n      },\n      \"name\": \"alerts-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SecurityAlert\\n| summarize arg_max(TimeGenerated, *) by SystemAlertId\\n| summarize Count = count() by bin(TimeGenerated, 4h)\\n| order by TimeGenerated asc\",\n              \"size\": 3,\n              \"title\": \"Alert Volume\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"linechart\",\n              \"chartSettings\": {\n                \"seriesLabelSettings\": [{ \"seriesName\": \"Count\", \"color\": \"orange\" }]\n              }\n            },\n            \"customWidth\": \"50\",\n            \"name\": \"alert-trend\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SecurityAlert\\n| summarize arg_max(TimeGenerated, *) by SystemAlertId\\n| summarize Count = count() by AlertSeverity\\n| order by case(AlertSeverity == \\\"High\\\", 1, AlertSeverity == \\\"Medium\\\", 2, AlertSeverity == \\\"Low\\\", 3, 4)\",\n              \"size\": 3,\n              \"title\": \"By Severity\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"piechart\",\n              \"chartSettings\": {\n                \"seriesLabelSettings\": [\n                  { \"seriesName\": \"High\", \"color\": \"redBright\" },\n                  { \"seriesName\": \"Medium\", \"color\": \"orange\" },\n                  { \"seriesName\": \"Low\", \"color\": \"yellow\" },\n                  { \"seriesName\": \"Informational\", \"color\": \"gray\" }\n                ]\n              }\n            },\n            \"customWidth\": \"25\",\n            \"name\": \"alerts-by-severity\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SecurityAlert\\n| summarize arg_max(TimeGenerated, *) by SystemAlertId\\n| summarize Count = count() by ProductName\\n| order by Count desc\",\n              \"size\": 3,\n              \"title\": \"By Product\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"piechart\"\n            },\n            \"customWidth\": \"25\",\n            \"name\": \"alerts-by-product\"\n          }\n        ]\n      },\n      \"name\": \"alerts-charts-group\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SecurityAlert\\n| summarize arg_max(TimeGenerated, *) by SystemAlertId\\n| summarize Count = count() by AlertName = DisplayName\\n| order by Count desc\\n| take 10\",\n              \"size\": 2,\n              \"title\": \"Top Alert Rules\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"table\",\n              \"gridSettings\": {\n                \"formatters\": [{ \"columnMatch\": \"Count\", \"formatter\": 4, \"formatOptions\": { \"palette\": \"orange\" } }]\n              }\n            },\n            \"customWidth\": \"40\",\n            \"name\": \"top-alert-rules\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SecurityAlert\\n| summarize arg_max(TimeGenerated, *) by SystemAlertId\\n| project TimeGenerated, AlertName = DisplayName, Severity = AlertSeverity, ProductName\\n| order by case(Severity == \\\"High\\\", 1, Severity == \\\"Medium\\\", 2, Severity == \\\"Low\\\", 3, 4), TimeGenerated desc\\n| take 10\",\n              \"size\": 2,\n              \"title\": \"Recent Alerts\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"table\",\n              \"gridSettings\": {\n                \"formatters\": [\n                  { \"columnMatch\": \"Severity\", \"formatter\": 18, \"formatOptions\": { \"thresholdsOptions\": \"colors\", \"thresholdsGrid\": [\n                    { \"operator\": \"==\", \"thresholdValue\": \"High\", \"representation\": \"redBright\", \"text\": \"{0}{1}\" },\n                    { \"operator\": \"==\", \"thresholdValue\": \"Medium\", \"representation\": \"orange\", \"text\": \"{0}{1}\" },\n                    { \"operator\": \"==\", \"thresholdValue\": \"Low\", \"representation\": \"yellow\", \"text\": \"{0}{1}\" },\n                    { \"operator\": \"Default\", \"representation\": \"gray\", \"text\": \"{0}{1}\" }\n                  ]}}\n                ]\n              }\n            },\n            \"customWidth\": \"60\",\n            \"name\": \"recent-alerts\"\n          }\n        ]\n      },\n      \"name\": \"alerts-tables-group\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## Entities\"\n      },\n      \"name\": \"entities-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SecurityAlert\\n| summarize arg_max(TimeGenerated, *) by SystemAlertId\\n| where isnotempty(Entities) and Entities != \\\"[]\\\"\\n| extend EntityList = todynamic(Entities)\\n| mv-expand Entity = EntityList\\n| where Entity.Type == \\\"account\\\"\\n| extend AccountName = coalesce(tostring(Entity.Name), tostring(Entity.AccountName), tostring(Entity.AadUserId))\\n| where isnotempty(AccountName)\\n| summarize AlertCount = count() by AccountName\\n| order by AlertCount desc\\n| take 5\",\n              \"size\": 2,\n              \"title\": \"Top Accounts\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"table\",\n              \"gridSettings\": {\n                \"formatters\": [{ \"columnMatch\": \"AlertCount\", \"formatter\": 4, \"formatOptions\": { \"palette\": \"redBright\" } }]\n              }\n            },\n            \"customWidth\": \"33\",\n            \"name\": \"top-accounts\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SecurityAlert\\n| summarize arg_max(TimeGenerated, *) by SystemAlertId\\n| where isnotempty(Entities) and Entities != \\\"[]\\\"\\n| extend EntityList = todynamic(Entities)\\n| mv-expand Entity = EntityList\\n| where Entity.Type == \\\"host\\\"\\n| extend HostName = coalesce(tostring(Entity.HostName), tostring(Entity.NetBiosName))\\n| where isnotempty(HostName)\\n| summarize AlertCount = count() by HostName\\n| order by AlertCount desc\\n| take 5\",\n              \"size\": 2,\n              \"title\": \"Top Hosts\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"table\",\n              \"gridSettings\": {\n                \"formatters\": [{ \"columnMatch\": \"AlertCount\", \"formatter\": 4, \"formatOptions\": { \"palette\": \"orange\" } }]\n              }\n            },\n            \"customWidth\": \"33\",\n            \"name\": \"top-hosts\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SecurityAlert\\n| summarize arg_max(TimeGenerated, *) by SystemAlertId\\n| where isnotempty(Entities) and Entities != \\\"[]\\\"\\n| extend EntityList = todynamic(Entities)\\n| mv-expand Entity = EntityList\\n| where Entity.Type == \\\"ip\\\"\\n| extend IPAddress = tostring(Entity.Address)\\n| where isnotempty(IPAddress)\\n| summarize AlertCount = count() by IPAddress\\n| order by AlertCount desc\\n| take 5\",\n              \"size\": 2,\n              \"title\": \"Top IPs\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"table\",\n              \"gridSettings\": {\n                \"formatters\": [{ \"columnMatch\": \"AlertCount\", \"formatter\": 4, \"formatOptions\": { \"palette\": \"blue\" } }]\n              }\n            },\n            \"customWidth\": \"33\",\n            \"name\": \"top-ips\"\n          }\n        ]\n      },\n      \"name\": \"entities-group\"\n    }\n  ],\n  \"$schema\": \"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"\n}\n</code></pre>"},{"location":"workbooks/mfa%20coverage/","title":"MFA Coverage Analysis","text":""},{"location":"workbooks/mfa%20coverage/#mfa-coverage-analysis","title":"MFA Coverage Analysis","text":"<p>Comprehensive MFA coverage analysis with special focus on privileged users.</p>"},{"location":"workbooks/mfa%20coverage/#sections","title":"Sections","text":"<ul> <li>Executive Summary - Overall MFA coverage metrics</li> <li>Privileged Users - Admin accounts MFA status, identified via directory role assignments</li> <li>Global Admin Focus - Dedicated analysis for Global Administrators</li> <li>MFA Methods - Breakdown by method with strength ratings (Phishing-Resistant/Strong/Weak)</li> <li>Users Without MFA - Users signing in with single-factor only</li> <li>MFA Registration - Recent security info registration activity</li> <li>Application Coverage - Per-app MFA enforcement rates</li> <li>Conditional Access - CA policies enforcing MFA</li> <li>Legacy Authentication - Users bypassing MFA via legacy protocols</li> <li>MFA Failures - Failed MFA challenges (potential attacks or issues)</li> </ul>"},{"location":"workbooks/mfa%20coverage/#template","title":"Template","text":"<pre><code>{\n  \"version\": \"Notebook/1.0\",\n  \"items\": [\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"# MFA Coverage Analysis\\n\\nComprehensive view of MFA enrollment, usage, and gaps across the organization with special focus on privileged accounts.\\n\\n---\"\n      },\n      \"name\": \"title\"\n    },\n    {\n      \"type\": 9,\n      \"content\": {\n        \"version\": \"KqlParameterItem/1.0\",\n        \"parameters\": [\n          {\n            \"version\": \"KqlParameterItem/1.0\",\n            \"name\": \"TimeRange\",\n            \"type\": 4,\n            \"isRequired\": true,\n            \"typeSettings\": {\n              \"selectableValues\": [\n                {\n                  \"durationMs\": 86400000\n                },\n                {\n                  \"durationMs\": 259200000\n                },\n                {\n                  \"durationMs\": 604800000\n                },\n                {\n                  \"durationMs\": 1209600000\n                },\n                {\n                  \"durationMs\": 2592000000\n                }\n              ],\n              \"allowCustom\": true\n            },\n            \"value\": {\n              \"durationMs\": 604800000\n            },\n            \"label\": \"Time Range\"\n          }\n        ],\n        \"style\": \"pills\"\n      },\n      \"name\": \"parameters\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"## Executive Summary\"\n      },\n      \"name\": \"summary-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| summarize Count = dcount(UserPrincipalName)\",\n              \"size\": 4,\n              \"title\": \"Active Users\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"blue\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"16\",\n            \"name\": \"active-users\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where AuthenticationRequirement == \\\"multiFactorAuthentication\\\"\\n| summarize Count = dcount(UserPrincipalName)\",\n              \"size\": 4,\n              \"title\": \"Users with MFA\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"green\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"16\",\n            \"name\": \"mfa-users\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"let MFAUsers = SigninLogs\\n| where AuthenticationRequirement == \\\"multiFactorAuthentication\\\"\\n| distinct UserPrincipalName;\\nSigninLogs\\n| where AuthenticationRequirement == \\\"singleFactorAuthentication\\\" and ResultType == 0\\n| distinct UserPrincipalName\\n| where UserPrincipalName !in (MFAUsers)\\n| summarize Count = count()\",\n              \"size\": 4,\n              \"title\": \"Users Without MFA\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"redBright\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"16\",\n            \"name\": \"no-mfa-users\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"let TotalUsers = SigninLogs\\n| summarize Total = dcount(UserPrincipalName)\\n| extend _key = 1;\\nlet MFAUsers = SigninLogs\\n| where AuthenticationRequirement == \\\"multiFactorAuthentication\\\"\\n| summarize MFA = dcount(UserPrincipalName)\\n| extend _key = 1;\\nTotalUsers\\n| join MFAUsers on _key\\n| extend Coverage = round(100.0 * MFA / Total, 1)\\n| project Coverage = strcat(Coverage, \\\"%\\\")\",\n              \"size\": 4,\n              \"title\": \"MFA Coverage Rate\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Coverage\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"blue\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"16\",\n            \"name\": \"mfa-coverage-rate\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where AuthenticationRequirement == \\\"singleFactorAuthentication\\\" and ResultType == 0\\n| summarize Count = count()\",\n              \"size\": 4,\n              \"title\": \"Single-Factor Sign-ins\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"orange\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"16\",\n            \"name\": \"single-factor-signins\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"AuditLogs\\n| where OperationName has \\\"security info\\\"\\n| where OperationName has \\\"registered\\\"\\n| summarize Count = dcount(tostring(TargetResources[0].userPrincipalName))\",\n              \"size\": 4,\n              \"title\": \"MFA Registrations\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"purple\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"16\",\n            \"name\": \"mfa-registrations\"\n          }\n        ]\n      },\n      \"name\": \"summary-tiles\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## Privileged Users - MFA Status\\n\\nFocus on administrative accounts and their MFA posture. Privileged users are identified by directory role assignments.\"\n      },\n      \"name\": \"privileged-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"let PrivilegedRoles = dynamic([\\\"Global Administrator\\\", \\\"Privileged Role Administrator\\\", \\\"Security Administrator\\\", \\\"Exchange Administrator\\\", \\\"SharePoint Administrator\\\", \\\"User Administrator\\\", \\\"Helpdesk Administrator\\\", \\\"Application Administrator\\\", \\\"Cloud Application Administrator\\\", \\\"Privileged Authentication Administrator\\\", \\\"Authentication Administrator\\\", \\\"Conditional Access Administrator\\\", \\\"Intune Administrator\\\", \\\"Azure AD Joined Device Local Administrator\\\", \\\"Groups Administrator\\\", \\\"Password Administrator\\\"]);\\nlet PrivilegedUsers = IdentityInfo\\n| where TimeGenerated &gt; ago(14d)\\n| summarize arg_max(TimeGenerated, *) by AccountUPN\\n| mv-expand AssignedRole = AssignedRoles\\n| extend AssignedRole = tostring(AssignedRole)\\n| where AssignedRole in (PrivilegedRoles)\\n| project UserPrincipalName = AccountUPN, RoleName = AssignedRole;\\nPrivilegedUsers\\n| summarize Roles = make_set(RoleName) by UserPrincipalName\\n| join kind=leftouter (\\n    SigninLogs\\n    | where AuthenticationRequirement == \\\"multiFactorAuthentication\\\"\\n    | summarize MFASignins = count(), LastMFA = max(TimeGenerated) by UserPrincipalName\\n) on UserPrincipalName\\n| join kind=leftouter (\\n    SigninLogs\\n    | where AuthenticationRequirement == \\\"singleFactorAuthentication\\\" and ResultType == 0\\n    | summarize SingleFactorSignins = count() by UserPrincipalName\\n) on UserPrincipalName\\n| extend \\n    MFAStatus = iff(isnotempty(MFASignins), \\\"MFA Active\\\", \\\"No MFA Observed\\\"),\\n    MFASignins = coalesce(MFASignins, 0),\\n    SingleFactorSignins = coalesce(SingleFactorSignins, 0)\\n| project \\n    UserPrincipalName,\\n    Roles,\\n    MFAStatus,\\n    MFASignins,\\n    SingleFactorSignins,\\n    LastMFA\\n| order by MFAStatus asc, SingleFactorSignins desc\",\n              \"size\": 2,\n              \"title\": \"Privileged Users MFA Overview\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"table\",\n              \"gridSettings\": {\n                \"formatters\": [\n                  {\n                    \"columnMatch\": \"MFAStatus\",\n                    \"formatter\": 18,\n                    \"formatOptions\": {\n                      \"thresholdsOptions\": \"colors\",\n                      \"thresholdsGrid\": [\n                        {\n                          \"operator\": \"==\",\n                          \"thresholdValue\": \"MFA Active\",\n                          \"representation\": \"green\",\n                          \"text\": \"{0}\"\n                        },\n                        {\n                          \"operator\": \"==\",\n                          \"thresholdValue\": \"No MFA Observed\",\n                          \"representation\": \"redBright\",\n                          \"text\": \"{0}\"\n                        },\n                        {\n                          \"operator\": \"Default\",\n                          \"text\": \"{0}\"\n                        }\n                      ]\n                    }\n                  },\n                  {\n                    \"columnMatch\": \"SingleFactorSignins\",\n                    \"formatter\": 8,\n                    \"formatOptions\": {\n                      \"palette\": \"orange\"\n                    }\n                  }\n                ]\n              }\n            },\n            \"name\": \"privileged-mfa-status\"\n          }\n        ]\n      },\n      \"name\": \"privileged-overview-group\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"let PrivilegedRoles = dynamic([\\\"Global Administrator\\\", \\\"Privileged Role Administrator\\\", \\\"Security Administrator\\\", \\\"Exchange Administrator\\\", \\\"SharePoint Administrator\\\", \\\"User Administrator\\\", \\\"Helpdesk Administrator\\\", \\\"Application Administrator\\\", \\\"Cloud Application Administrator\\\", \\\"Privileged Authentication Administrator\\\", \\\"Authentication Administrator\\\", \\\"Conditional Access Administrator\\\", \\\"Intune Administrator\\\"]);\\nlet PrivilegedUsers = IdentityInfo\\n| where TimeGenerated &gt; ago(14d)\\n| summarize arg_max(TimeGenerated, *) by AccountUPN\\n| mv-expand AssignedRole = AssignedRoles\\n| extend AssignedRole = tostring(AssignedRole)\\n| where AssignedRole in (PrivilegedRoles)\\n| distinct AccountUPN;\\nSigninLogs\\n| where UserPrincipalName in (PrivilegedUsers)\\n| summarize \\n    MFACount = countif(AuthenticationRequirement == \\\"multiFactorAuthentication\\\"),\\n    SingleFactorCount = countif(AuthenticationRequirement == \\\"singleFactorAuthentication\\\" and ResultType == 0)\\n| extend Total = MFACount + SingleFactorCount\\n| project \\n    Category = \\\"MFA\\\", Count = MFACount\\n| union (\\n    SigninLogs\\n    | where UserPrincipalName in (PrivilegedUsers)\\n    | summarize \\n        MFACount = countif(AuthenticationRequirement == \\\"multiFactorAuthentication\\\"),\\n        SingleFactorCount = countif(AuthenticationRequirement == \\\"singleFactorAuthentication\\\" and ResultType == 0)\\n    | project Category = \\\"Single Factor\\\", Count = SingleFactorCount\\n)\",\n              \"size\": 2,\n              \"title\": \"Privileged User Auth Distribution\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"piechart\",\n              \"chartSettings\": {\n                \"seriesLabelSettings\": [\n                  {\n                    \"seriesName\": \"MFA\",\n                    \"color\": \"green\"\n                  },\n                  {\n                    \"seriesName\": \"Single Factor\",\n                    \"color\": \"redBright\"\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"35\",\n            \"name\": \"privileged-auth-pie\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"let PrivilegedRoles = dynamic([\\\"Global Administrator\\\", \\\"Privileged Role Administrator\\\", \\\"Security Administrator\\\", \\\"Exchange Administrator\\\", \\\"SharePoint Administrator\\\", \\\"User Administrator\\\", \\\"Helpdesk Administrator\\\", \\\"Application Administrator\\\", \\\"Cloud Application Administrator\\\", \\\"Privileged Authentication Administrator\\\", \\\"Authentication Administrator\\\", \\\"Conditional Access Administrator\\\", \\\"Intune Administrator\\\"]);\\nIdentityInfo\\n| where TimeGenerated &gt; ago(14d)\\n| summarize arg_max(TimeGenerated, *) by AccountUPN\\n| mv-expand AssignedRole = AssignedRoles\\n| extend RoleName = tostring(AssignedRole)\\n| where RoleName in (PrivilegedRoles)\\n| summarize Users = dcount(AccountUPN) by RoleName\\n| order by Users desc\",\n              \"size\": 2,\n              \"title\": \"Privileged Role Distribution\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"barchart\",\n              \"chartSettings\": {\n                \"xAxis\": \"RoleName\",\n                \"yAxis\": [\n                  \"Users\"\n                ],\n                \"seriesLabelSettings\": [\n                  {\n                    \"seriesName\": \"Users\",\n                    \"color\": \"purple\"\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"65\",\n            \"name\": \"role-distribution\"\n          }\n        ]\n      },\n      \"name\": \"privileged-charts-group\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"let PrivilegedRoles = dynamic([\\\"Global Administrator\\\", \\\"Privileged Role Administrator\\\", \\\"Security Administrator\\\", \\\"Exchange Administrator\\\", \\\"SharePoint Administrator\\\", \\\"User Administrator\\\", \\\"Helpdesk Administrator\\\", \\\"Application Administrator\\\", \\\"Cloud Application Administrator\\\", \\\"Privileged Authentication Administrator\\\", \\\"Authentication Administrator\\\", \\\"Conditional Access Administrator\\\", \\\"Intune Administrator\\\"]);\\nlet PrivilegedUsers = IdentityInfo\\n| where TimeGenerated &gt; ago(14d)\\n| summarize arg_max(TimeGenerated, *) by AccountUPN\\n| mv-expand AssignedRole = AssignedRoles\\n| extend AssignedRole = tostring(AssignedRole)\\n| where AssignedRole in (PrivilegedRoles)\\n| summarize Roles = make_set(AssignedRole) by UserPrincipalName = AccountUPN;\\nSigninLogs\\n| where AuthenticationRequirement == \\\"singleFactorAuthentication\\\" and ResultType == 0\\n| join kind=inner PrivilegedUsers on UserPrincipalName\\n| extend \\n    City = tostring(LocationDetails.city),\\n    Country = tostring(LocationDetails.countryOrRegion)\\n| project \\n    TimeGenerated,\\n    UserPrincipalName,\\n    Roles,\\n    AppDisplayName,\\n    IPAddress,\\n    Location = strcat(City, \\\", \\\", Country),\\n    ClientAppUsed,\\n    UserAgent\\n| order by TimeGenerated desc\\n| take 50\",\n        \"size\": 2,\n        \"title\": \"Privileged Users - Single Factor Sign-ins (Last 50)\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\",\n        \"gridSettings\": {\n          \"formatters\": [\n            {\n              \"columnMatch\": \"Roles\",\n              \"formatter\": 7,\n              \"formatOptions\": {\n                \"linkTarget\": \"CellDetails\",\n                \"linkIsContextBlade\": true\n              }\n            }\n          ]\n        }\n      },\n      \"name\": \"privileged-single-factor\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## Global Admin Focus\\n\\nGlobal Administrators have the highest privilege level. This section provides detailed analysis of their MFA status.\"\n      },\n      \"name\": \"global-admin-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"let GlobalAdmins = IdentityInfo\\n| where TimeGenerated &gt; ago(14d)\\n| summarize arg_max(TimeGenerated, *) by AccountUPN\\n| where AssignedRoles has \\\"Global Administrator\\\"\\n| distinct AccountUPN;\\nGlobalAdmins\\n| summarize Count = count()\",\n              \"size\": 4,\n              \"title\": \"Total Global Admins\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"purple\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"25\",\n            \"name\": \"ga-count\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"let GlobalAdmins = IdentityInfo\\n| where TimeGenerated &gt; ago(14d)\\n| summarize arg_max(TimeGenerated, *) by AccountUPN\\n| where AssignedRoles has \\\"Global Administrator\\\"\\n| distinct AccountUPN;\\nSigninLogs\\n| where UserPrincipalName in (GlobalAdmins)\\n| where AuthenticationRequirement == \\\"multiFactorAuthentication\\\"\\n| summarize Count = dcount(UserPrincipalName)\",\n              \"size\": 4,\n              \"title\": \"GAs with MFA\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"green\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"25\",\n            \"name\": \"ga-mfa\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"let GlobalAdmins = IdentityInfo\\n| where TimeGenerated &gt; ago(14d)\\n| summarize arg_max(TimeGenerated, *) by AccountUPN\\n| where AssignedRoles has \\\"Global Administrator\\\"\\n| distinct AccountUPN;\\nlet GAWithMFA = SigninLogs\\n| where UserPrincipalName in (GlobalAdmins)\\n| where AuthenticationRequirement == \\\"multiFactorAuthentication\\\"\\n| distinct UserPrincipalName;\\nSigninLogs\\n| where UserPrincipalName in (GlobalAdmins)\\n| where AuthenticationRequirement == \\\"singleFactorAuthentication\\\" and ResultType == 0\\n| distinct UserPrincipalName\\n| where UserPrincipalName !in (GAWithMFA)\\n| summarize Count = count()\",\n              \"size\": 4,\n              \"title\": \"GAs Without MFA\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"redBright\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"25\",\n            \"name\": \"ga-no-mfa\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"let GlobalAdmins = IdentityInfo\\n| where TimeGenerated &gt; ago(14d)\\n| summarize arg_max(TimeGenerated, *) by AccountUPN\\n| where AssignedRoles has \\\"Global Administrator\\\"\\n| distinct AccountUPN;\\nSigninLogs\\n| where UserPrincipalName in (GlobalAdmins)\\n| summarize Count = count()\",\n              \"size\": 4,\n              \"title\": \"GA Sign-ins\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"blue\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"25\",\n            \"name\": \"ga-signins\"\n          }\n        ]\n      },\n      \"name\": \"global-admin-tiles\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"let GlobalAdmins = IdentityInfo\\n| where TimeGenerated &gt; ago(14d)\\n| summarize arg_max(TimeGenerated, *) by AccountUPN\\n| where AssignedRoles has \\\"Global Administrator\\\"\\n| distinct AccountUPN;\\nSigninLogs\\n| where UserPrincipalName in (GlobalAdmins)\\n| extend MFAMethod = tostring(MfaDetail.authMethod)\\n| summarize \\n    TotalSignins = count(),\\n    MFASignins = countif(AuthenticationRequirement == \\\"multiFactorAuthentication\\\"),\\n    SingleFactorSignins = countif(AuthenticationRequirement == \\\"singleFactorAuthentication\\\" and ResultType == 0),\\n    FailedSignins = countif(ResultType != 0),\\n    UniqueIPs = dcount(IPAddress),\\n    LastSignin = max(TimeGenerated),\\n    MFAMethods = make_set_if(MFAMethod, isnotempty(MFAMethod))\\n    by UserPrincipalName\\n| extend MFACoverage = round(100.0 * MFASignins / TotalSignins, 1)\\n| project \\n    UserPrincipalName,\\n    TotalSignins,\\n    MFACoverage = strcat(MFACoverage, \\\"%\\\"),\\n    MFASignins,\\n    SingleFactorSignins,\\n    FailedSignins,\\n    UniqueIPs,\\n    MFAMethods,\\n    LastSignin\\n| order by SingleFactorSignins desc\",\n        \"size\": 2,\n        \"title\": \"Global Admin Sign-in Details\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\",\n        \"gridSettings\": {\n          \"formatters\": [\n            {\n              \"columnMatch\": \"SingleFactorSignins\",\n              \"formatter\": 8,\n              \"formatOptions\": {\n                \"palette\": \"orange\"\n              }\n            },\n            {\n              \"columnMatch\": \"FailedSignins\",\n              \"formatter\": 8,\n              \"formatOptions\": {\n                \"palette\": \"redBright\"\n              }\n            }\n          ]\n        }\n      },\n      \"name\": \"ga-details\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## MFA Methods Analysis\\n\\nBreakdown of authentication methods used across the organization.\"\n      },\n      \"name\": \"methods-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where AuthenticationRequirement == \\\"multiFactorAuthentication\\\"\\n| extend MFAMethod = tostring(MfaDetail.authMethod)\\n| where isnotempty(MFAMethod)\\n| summarize Count = count() by MFAMethod\\n| order by Count desc\",\n              \"size\": 2,\n              \"title\": \"MFA Methods Distribution\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"piechart\",\n              \"chartSettings\": {\n                \"seriesLabelSettings\": [\n                  {\n                    \"seriesName\": \"PhoneAppNotification\",\n                    \"color\": \"green\"\n                  },\n                  {\n                    \"seriesName\": \"PhoneAppOTP\",\n                    \"color\": \"blue\"\n                  },\n                  {\n                    \"seriesName\": \"OneWaySMS\",\n                    \"color\": \"yellow\"\n                  },\n                  {\n                    \"seriesName\": \"TwoWayVoiceMobile\",\n                    \"color\": \"orange\"\n                  },\n                  {\n                    \"seriesName\": \"FIDO2\",\n                    \"color\": \"purple\"\n                  },\n                  {\n                    \"seriesName\": \"WindowsHelloForBusiness\",\n                    \"color\": \"teal\"\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"40\",\n            \"name\": \"mfa-methods-pie\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where AuthenticationRequirement == \\\"multiFactorAuthentication\\\"\\n| extend MFAMethod = tostring(MfaDetail.authMethod)\\n| where isnotempty(MFAMethod)\\n| summarize \\n    Count = count(),\\n    UniqueUsers = dcount(UserPrincipalName)\\n    by MFAMethod\\n| extend \\n    MethodStrength = case(\\n        MFAMethod in (\\\"FIDO2\\\", \\\"WindowsHelloForBusiness\\\", \\\"Passwordless\\\"), \\\"Phishing-Resistant\\\",\\n        MFAMethod in (\\\"PhoneAppNotification\\\", \\\"PhoneAppOTP\\\"), \\\"Strong\\\",\\n        MFAMethod in (\\\"OneWaySMS\\\", \\\"TwoWayVoiceMobile\\\", \\\"TwoWayVoiceOffice\\\"), \\\"Weak\\\",\\n        \\\"Other\\\"\\n    )\\n| project \\n    MFAMethod,\\n    MethodStrength,\\n    SigninCount = Count,\\n    UniqueUsers\\n| order by SigninCount desc\",\n              \"size\": 2,\n              \"title\": \"MFA Methods with Strength Rating\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"table\",\n              \"gridSettings\": {\n                \"formatters\": [\n                  {\n                    \"columnMatch\": \"MethodStrength\",\n                    \"formatter\": 18,\n                    \"formatOptions\": {\n                      \"thresholdsOptions\": \"colors\",\n                      \"thresholdsGrid\": [\n                        {\n                          \"operator\": \"==\",\n                          \"thresholdValue\": \"Phishing-Resistant\",\n                          \"representation\": \"green\",\n                          \"text\": \"{0}\"\n                        },\n                        {\n                          \"operator\": \"==\",\n                          \"thresholdValue\": \"Strong\",\n                          \"representation\": \"blue\",\n                          \"text\": \"{0}\"\n                        },\n                        {\n                          \"operator\": \"==\",\n                          \"thresholdValue\": \"Weak\",\n                          \"representation\": \"orange\",\n                          \"text\": \"{0}\"\n                        },\n                        {\n                          \"operator\": \"Default\",\n                          \"text\": \"{0}\"\n                        }\n                      ]\n                    }\n                  },\n                  {\n                    \"columnMatch\": \"SigninCount\",\n                    \"formatter\": 4,\n                    \"formatOptions\": {\n                      \"palette\": \"blue\"\n                    }\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"60\",\n            \"name\": \"mfa-methods-table\"\n          }\n        ]\n      },\n      \"name\": \"methods-overview-group\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where AuthenticationRequirement == \\\"multiFactorAuthentication\\\"\\n| extend MFAMethod = tostring(MfaDetail.authMethod)\\n| where MFAMethod in (\\\"OneWaySMS\\\", \\\"TwoWayVoiceMobile\\\", \\\"TwoWayVoiceOffice\\\")\\n| summarize Count = dcount(UserPrincipalName)\",\n              \"size\": 4,\n              \"title\": \"Users with Weak MFA (SMS/Voice)\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"orange\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"33\",\n            \"name\": \"weak-mfa-count\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where AuthenticationRequirement == \\\"multiFactorAuthentication\\\"\\n| extend MFAMethod = tostring(MfaDetail.authMethod)\\n| where MFAMethod in (\\\"PhoneAppNotification\\\", \\\"PhoneAppOTP\\\")\\n| summarize Count = dcount(UserPrincipalName)\",\n              \"size\": 4,\n              \"title\": \"Users with Authenticator App\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"blue\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"33\",\n            \"name\": \"authenticator-count\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where AuthenticationRequirement == \\\"multiFactorAuthentication\\\"\\n| extend MFAMethod = tostring(MfaDetail.authMethod)\\n| where MFAMethod in (\\\"FIDO2\\\", \\\"WindowsHelloForBusiness\\\", \\\"Passwordless\\\")\\n| summarize Count = dcount(UserPrincipalName)\",\n              \"size\": 4,\n              \"title\": \"Users with Phishing-Resistant MFA\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"green\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"33\",\n            \"name\": \"phishing-resistant-count\"\n          }\n        ]\n      },\n      \"name\": \"method-strength-tiles\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"SigninLogs\\n| where AuthenticationRequirement == \\\"multiFactorAuthentication\\\"\\n| extend MFAMethod = tostring(MfaDetail.authMethod)\\n| where MFAMethod in (\\\"OneWaySMS\\\", \\\"TwoWayVoiceMobile\\\", \\\"TwoWayVoiceOffice\\\")\\n| summarize \\n    SigninCount = count(),\\n    LastUse = max(TimeGenerated)\\n    by UserPrincipalName, UserDisplayName, MFAMethod\\n| order by SigninCount desc\\n| take 25\",\n        \"size\": 2,\n        \"title\": \"Users Relying on Weak MFA Methods (Top 25)\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\",\n        \"gridSettings\": {\n          \"formatters\": [\n            {\n              \"columnMatch\": \"MFAMethod\",\n              \"formatter\": 18,\n              \"formatOptions\": {\n                \"thresholdsOptions\": \"colors\",\n                \"thresholdsGrid\": [\n                  {\n                    \"operator\": \"Default\",\n                    \"representation\": \"orange\",\n                    \"text\": \"{0}\"\n                  }\n                ]\n              }\n            },\n            {\n              \"columnMatch\": \"SigninCount\",\n              \"formatter\": 8,\n              \"formatOptions\": {\n                \"palette\": \"orange\"\n              }\n            }\n          ]\n        }\n      },\n      \"name\": \"weak-mfa-users\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## Users Without MFA Coverage\\n\\nUsers who have signed in successfully without MFA during the selected time period.\"\n      },\n      \"name\": \"no-mfa-header\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"let MFAUsers = SigninLogs\\n| where AuthenticationRequirement == \\\"multiFactorAuthentication\\\"\\n| distinct UserPrincipalName;\\nSigninLogs\\n| where AuthenticationRequirement == \\\"singleFactorAuthentication\\\" and ResultType == 0\\n| where UserPrincipalName !in (MFAUsers)\\n| summarize \\n    SigninCount = count(),\\n    UniqueIPs = dcount(IPAddress),\\n    Apps = make_set(AppDisplayName, 5),\\n    LastSignin = max(TimeGenerated)\\n    by UserPrincipalName, UserDisplayName\\n| order by SigninCount desc\\n| take 50\\n| project \\n    UserDisplayName,\\n    UserPrincipalName,\\n    SigninCount,\\n    UniqueIPs,\\n    Apps,\\n    LastSignin\",\n        \"size\": 2,\n        \"title\": \"Users with Only Single-Factor Sign-ins (Top 50)\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\",\n        \"gridSettings\": {\n          \"formatters\": [\n            {\n              \"columnMatch\": \"SigninCount\",\n              \"formatter\": 8,\n              \"formatOptions\": {\n                \"palette\": \"redBright\"\n              }\n            }\n          ]\n        }\n      },\n      \"name\": \"no-mfa-users\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"SigninLogs\\n| where AuthenticationRequirement == \\\"singleFactorAuthentication\\\" and ResultType == 0\\n| summarize SingleFactorSignins = count() by bin(TimeGenerated, 1h)\\n| order by TimeGenerated asc\",\n        \"size\": 0,\n        \"title\": \"Single-Factor Sign-ins Over Time\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"linechart\",\n        \"chartSettings\": {\n          \"seriesLabelSettings\": [\n            {\n              \"seriesName\": \"SingleFactorSignins\",\n              \"color\": \"orange\"\n            }\n          ]\n        }\n      },\n      \"name\": \"single-factor-trend\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## MFA Registration Activity\\n\\nRecent MFA and security info registration events.\"\n      },\n      \"name\": \"registration-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"AuditLogs\\n| where OperationName has \\\"security info\\\"\\n| where OperationName has \\\"registered\\\"\\n| summarize Registrations = count() by bin(TimeGenerated, 1d)\\n| order by TimeGenerated asc\",\n              \"size\": 0,\n              \"title\": \"MFA Registrations Over Time\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"linechart\",\n              \"chartSettings\": {\n                \"seriesLabelSettings\": [\n                  {\n                    \"seriesName\": \"Registrations\",\n                    \"color\": \"green\"\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"60\",\n            \"name\": \"registration-trend\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"AuditLogs\\n| where OperationName has \\\"security info\\\"\\n| extend Method = tostring(AdditionalDetails[0].value)\\n| where isnotempty(Method)\\n| summarize Count = count() by Method\\n| order by Count desc\",\n              \"size\": 2,\n              \"title\": \"Registered Methods\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"piechart\"\n            },\n            \"customWidth\": \"40\",\n            \"name\": \"registered-methods-pie\"\n          }\n        ]\n      },\n      \"name\": \"registration-group\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"AuditLogs\\n| where OperationName has_any (\\\"User registered security info\\\", \\\"User registered all required security info\\\", \\\"Admin registered security info\\\", \\\"User deleted security info\\\", \\\"Admin deleted security info\\\")\\n| extend \\n    UserUPN = tostring(TargetResources[0].userPrincipalName),\\n    Method = tostring(AdditionalDetails[0].value),\\n    InitiatedBy = coalesce(\\n        tostring(InitiatedBy.user.userPrincipalName),\\n        tostring(InitiatedBy.app.displayName),\\n        \\\"Unknown\\\"\\n    )\\n| project \\n    TimeGenerated,\\n    OperationName,\\n    UserUPN,\\n    Method,\\n    InitiatedBy,\\n    Result\\n| order by TimeGenerated desc\\n| take 50\",\n        \"size\": 2,\n        \"title\": \"Recent MFA Registration Events (Last 50)\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\",\n        \"gridSettings\": {\n          \"formatters\": [\n            {\n              \"columnMatch\": \"OperationName\",\n              \"formatter\": 18,\n              \"formatOptions\": {\n                \"thresholdsOptions\": \"colors\",\n                \"thresholdsGrid\": [\n                  {\n                    \"operator\": \"contains\",\n                    \"thresholdValue\": \"deleted\",\n                    \"representation\": \"redBright\",\n                    \"text\": \"{0}\"\n                  },\n                  {\n                    \"operator\": \"contains\",\n                    \"thresholdValue\": \"registered\",\n                    \"representation\": \"green\",\n                    \"text\": \"{0}\"\n                  },\n                  {\n                    \"operator\": \"Default\",\n                    \"text\": \"{0}\"\n                  }\n                ]\n              }\n            },\n            {\n              \"columnMatch\": \"Result\",\n              \"formatter\": 18,\n              \"formatOptions\": {\n                \"thresholdsOptions\": \"icons\",\n                \"thresholdsGrid\": [\n                  {\n                    \"operator\": \"==\",\n                    \"thresholdValue\": \"success\",\n                    \"representation\": \"success\",\n                    \"text\": \"{0}\"\n                  },\n                  {\n                    \"operator\": \"Default\",\n                    \"representation\": \"warning\",\n                    \"text\": \"{0}\"\n                  }\n                ]\n              }\n            }\n          ]\n        }\n      },\n      \"name\": \"registration-events\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## Application MFA Coverage\\n\\nMFA enforcement by application - identify apps allowing single-factor authentication.\"\n      },\n      \"name\": \"app-header\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"SigninLogs\\n| where ResultType == 0\\n| summarize \\n    TotalSignins = count(),\\n    MFASignins = countif(AuthenticationRequirement == \\\"multiFactorAuthentication\\\"),\\n    SingleFactorSignins = countif(AuthenticationRequirement == \\\"singleFactorAuthentication\\\"),\\n    UniqueUsers = dcount(UserPrincipalName)\\n    by AppDisplayName\\n| extend MFACoverage = round(100.0 * MFASignins / TotalSignins, 1)\\n| where TotalSignins &gt; 10\\n| project \\n    AppDisplayName,\\n    TotalSignins,\\n    MFACoverage = strcat(MFACoverage, \\\"%\\\"),\\n    MFASignins,\\n    SingleFactorSignins,\\n    UniqueUsers\\n| order by SingleFactorSignins desc\\n| take 25\",\n        \"size\": 2,\n        \"title\": \"Application MFA Coverage (Apps with &gt;10 sign-ins)\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\",\n        \"gridSettings\": {\n          \"formatters\": [\n            {\n              \"columnMatch\": \"SingleFactorSignins\",\n              \"formatter\": 8,\n              \"formatOptions\": {\n                \"palette\": \"orange\"\n              }\n            },\n            {\n              \"columnMatch\": \"MFASignins\",\n              \"formatter\": 8,\n              \"formatOptions\": {\n                \"palette\": \"green\"\n              }\n            }\n          ]\n        }\n      },\n      \"name\": \"app-mfa-coverage\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## Conditional Access &amp; MFA\\n\\nAnalysis of Conditional Access policies enforcing MFA.\"\n      },\n      \"name\": \"ca-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where AuthenticationRequirement == \\\"multiFactorAuthentication\\\"\\n| mv-expand CAPolicy = ConditionalAccessPolicies\\n| where CAPolicy.result == \\\"success\\\"\\n| extend PolicyName = tostring(CAPolicy.displayName)\\n| summarize MFAEnforced = count() by PolicyName\\n| order by MFAEnforced desc\\n| take 10\",\n              \"size\": 2,\n              \"title\": \"Top CA Policies Enforcing MFA\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"table\",\n              \"gridSettings\": {\n                \"formatters\": [\n                  {\n                    \"columnMatch\": \"MFAEnforced\",\n                    \"formatter\": 4,\n                    \"formatOptions\": {\n                      \"palette\": \"green\"\n                    }\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"50\",\n            \"name\": \"ca-mfa-policies\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where AuthenticationRequirement == \\\"singleFactorAuthentication\\\" and ResultType == 0\\n| extend CAStatus = case(\\n    ConditionalAccessStatus == \\\"notApplied\\\", \\\"No CA Applied\\\",\\n    ConditionalAccessStatus == \\\"success\\\", \\\"CA Passed (No MFA Required)\\\",\\n    ConditionalAccessStatus\\n)\\n| summarize Count = count() by CAStatus\\n| order by Count desc\",\n              \"size\": 2,\n              \"title\": \"Single-Factor Sign-ins by CA Status\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"piechart\",\n              \"chartSettings\": {\n                \"seriesLabelSettings\": [\n                  {\n                    \"seriesName\": \"No CA Applied\",\n                    \"color\": \"redBright\"\n                  },\n                  {\n                    \"seriesName\": \"CA Passed (No MFA Required)\",\n                    \"color\": \"orange\"\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"50\",\n            \"name\": \"single-factor-ca\"\n          }\n        ]\n      },\n      \"name\": \"ca-group\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## Legacy Authentication &amp; MFA\\n\\nLegacy protocols that bypass MFA - high security risk.\"\n      },\n      \"name\": \"legacy-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"let LegacyProtocols = dynamic([\\\"Authenticated SMTP\\\", \\\"Autodiscover\\\", \\\"Exchange ActiveSync\\\", \\\"Exchange Online PowerShell\\\", \\\"Exchange Web Services\\\", \\\"IMAP4\\\", \\\"MAPI Over HTTP\\\", \\\"Offline Address Book\\\", \\\"Outlook Anywhere (RPC over HTTP)\\\", \\\"Other clients\\\", \\\"POP3\\\", \\\"Reporting Web Services\\\"]);\\nSigninLogs\\n| where ClientAppUsed in (LegacyProtocols) and ResultType == 0\\n| summarize Count = dcount(UserPrincipalName)\",\n              \"size\": 4,\n              \"title\": \"Users with Legacy Auth (Bypasses MFA)\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"redBright\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"25\",\n            \"name\": \"legacy-users-count\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"let LegacyProtocols = dynamic([\\\"Authenticated SMTP\\\", \\\"Autodiscover\\\", \\\"Exchange ActiveSync\\\", \\\"Exchange Online PowerShell\\\", \\\"Exchange Web Services\\\", \\\"IMAP4\\\", \\\"MAPI Over HTTP\\\", \\\"Offline Address Book\\\", \\\"Outlook Anywhere (RPC over HTTP)\\\", \\\"Other clients\\\", \\\"POP3\\\", \\\"Reporting Web Services\\\"]);\\nSigninLogs\\n| where ClientAppUsed in (LegacyProtocols) and ResultType == 0\\n| summarize Count = count()\",\n              \"size\": 4,\n              \"title\": \"Legacy Auth Sign-ins\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"orange\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"25\",\n            \"name\": \"legacy-signins-count\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"let LegacyProtocols = dynamic([\\\"Authenticated SMTP\\\", \\\"Autodiscover\\\", \\\"Exchange ActiveSync\\\", \\\"Exchange Online PowerShell\\\", \\\"Exchange Web Services\\\", \\\"IMAP4\\\", \\\"MAPI Over HTTP\\\", \\\"Offline Address Book\\\", \\\"Outlook Anywhere (RPC over HTTP)\\\", \\\"Other clients\\\", \\\"POP3\\\", \\\"Reporting Web Services\\\"]);\\nSigninLogs\\n| where ClientAppUsed in (LegacyProtocols) and ResultType == 0\\n| summarize Count = count() by ClientAppUsed\\n| order by Count desc\",\n              \"size\": 2,\n              \"title\": \"Legacy Protocols Used\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"piechart\"\n            },\n            \"customWidth\": \"50\",\n            \"name\": \"legacy-protocols-pie\"\n          }\n        ]\n      },\n      \"name\": \"legacy-overview\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"let LegacyProtocols = dynamic([\\\"Authenticated SMTP\\\", \\\"Autodiscover\\\", \\\"Exchange ActiveSync\\\", \\\"Exchange Online PowerShell\\\", \\\"Exchange Web Services\\\", \\\"IMAP4\\\", \\\"MAPI Over HTTP\\\", \\\"Offline Address Book\\\", \\\"Outlook Anywhere (RPC over HTTP)\\\", \\\"Other clients\\\", \\\"POP3\\\", \\\"Reporting Web Services\\\"]);\\nSigninLogs\\n| where ClientAppUsed in (LegacyProtocols) and ResultType == 0\\n| summarize \\n    SigninCount = count(),\\n    Protocols = make_set(ClientAppUsed),\\n    LastUse = max(TimeGenerated)\\n    by UserPrincipalName, UserDisplayName\\n| order by SigninCount desc\\n| take 25\\n| project \\n    UserDisplayName,\\n    UserPrincipalName,\\n    SigninCount,\\n    Protocols,\\n    LastUse\",\n        \"size\": 2,\n        \"title\": \"Users with Legacy Auth (MFA Bypass Risk) - Top 25\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\",\n        \"gridSettings\": {\n          \"formatters\": [\n            {\n              \"columnMatch\": \"SigninCount\",\n              \"formatter\": 8,\n              \"formatOptions\": {\n                \"palette\": \"redBright\"\n              }\n            }\n          ]\n        }\n      },\n      \"name\": \"legacy-users\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## MFA Failures\\n\\nMFA challenges that failed - could indicate attacks or user issues.\"\n      },\n      \"name\": \"failures-header\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"SigninLogs\\n| where ResultType in (\\\"50074\\\", \\\"50076\\\", \\\"500121\\\", \\\"50158\\\")\\n| extend FailureReason = case(\\n    ResultType == \\\"50074\\\", \\\"MFA Required - User didn't complete\\\",\\n    ResultType == \\\"50076\\\", \\\"MFA Required (Admin Policy)\\\",\\n    ResultType == \\\"500121\\\", \\\"MFA Failed - Wrong code/timeout\\\",\\n    ResultType == \\\"50158\\\", \\\"External Security Challenge Failed\\\",\\n    \\\"Other MFA Failure\\\"\\n)\\n| summarize \\n    FailureCount = count(),\\n    LastFailure = max(TimeGenerated)\\n    by UserPrincipalName, UserDisplayName, FailureReason\\n| order by FailureCount desc\\n| take 25\",\n        \"size\": 2,\n        \"title\": \"MFA Failures by User (Top 25)\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\",\n        \"gridSettings\": {\n          \"formatters\": [\n            {\n              \"columnMatch\": \"FailureCount\",\n              \"formatter\": 8,\n              \"formatOptions\": {\n                \"palette\": \"redBright\"\n              }\n            },\n            {\n              \"columnMatch\": \"FailureReason\",\n              \"formatter\": 18,\n              \"formatOptions\": {\n                \"thresholdsOptions\": \"colors\",\n                \"thresholdsGrid\": [\n                  {\n                    \"operator\": \"contains\",\n                    \"thresholdValue\": \"Failed\",\n                    \"representation\": \"redBright\",\n                    \"text\": \"{0}\"\n                  },\n                  {\n                    \"operator\": \"Default\",\n                    \"representation\": \"orange\",\n                    \"text\": \"{0}\"\n                  }\n                ]\n              }\n            }\n          ]\n        }\n      },\n      \"name\": \"mfa-failures\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"SigninLogs\\n| where ResultType in (\\\"50074\\\", \\\"50076\\\", \\\"500121\\\", \\\"50158\\\")\\n| summarize Failures = count() by bin(TimeGenerated, 1h)\\n| order by TimeGenerated asc\",\n        \"size\": 0,\n        \"title\": \"MFA Failures Over Time\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"linechart\",\n        \"chartSettings\": {\n          \"seriesLabelSettings\": [\n            {\n              \"seriesName\": \"Failures\",\n              \"color\": \"redBright\"\n            }\n          ]\n        }\n      },\n      \"name\": \"mfa-failures-trend\"\n    }\n  ],\n  \"$schema\": \"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"\n}\n</code></pre>"},{"location":"workbooks/sign-in%20analyzer/","title":"Sign-in Analyzer","text":""},{"location":"workbooks/sign-in%20analyzer/#sign-in-analyzer","title":"Sign-in Analyzer","text":""},{"location":"workbooks/sign-in%20analyzer/#template","title":"Template","text":"<pre><code>{\n  \"version\": \"Notebook/1.0\",\n  \"items\": [\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"# Sign-in Analyzer Dashboard\\n---\"\n      },\n      \"name\": \"title\"\n    },\n    {\n      \"type\": 9,\n      \"content\": {\n        \"version\": \"KqlParameterItem/1.0\",\n        \"parameters\": [\n          {\n            \"version\": \"KqlParameterItem/1.0\",\n            \"name\": \"TimeRange\",\n            \"type\": 4,\n            \"isRequired\": true,\n            \"typeSettings\": {\n              \"selectableValues\": [\n                {\n                  \"durationMs\": 3600000\n                },\n                {\n                  \"durationMs\": 14400000\n                },\n                {\n                  \"durationMs\": 86400000\n                },\n                {\n                  \"durationMs\": 259200000\n                },\n                {\n                  \"durationMs\": 604800000\n                },\n                {\n                  \"durationMs\": 1209600000\n                },\n                {\n                  \"durationMs\": 2592000000\n                }\n              ],\n              \"allowCustom\": true\n            },\n            \"value\": {\n              \"durationMs\": 604800000\n            },\n            \"label\": \"Time Range\"\n          },\n          {\n            \"version\": \"KqlParameterItem/1.0\",\n            \"name\": \"HasRiskySignins\",\n            \"type\": 1,\n            \"isRequired\": false,\n            \"query\": \"SigninLogs\\n| where RiskLevelDuringSignIn in (\\\"low\\\", \\\"medium\\\", \\\"high\\\")\\n| summarize Count = count()\\n| extend HasData = iff(Count &gt; 0, \\\"true\\\", \\\"\\\")\\n| project HasData\",\n            \"timeContextFromParameter\": \"TimeRange\",\n            \"queryType\": 0,\n            \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n            \"isHiddenWhenLocked\": true\n          }\n        ],\n        \"style\": \"pills\"\n      },\n      \"name\": \"parameters\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"## Overview\"\n      },\n      \"name\": \"overview-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| summarize Count = count()\",\n              \"size\": 4,\n              \"title\": \"Total Sign-ins\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"lightBlue\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"20\",\n            \"name\": \"total-signins\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where ResultType != 0\\n| summarize Count = count()\",\n              \"size\": 4,\n              \"title\": \"Failed Sign-ins\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"redBright\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"20\",\n            \"name\": \"failed-signins\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where ConditionalAccessStatus == \\\"failure\\\"\\n| summarize Count = count()\",\n              \"size\": 4,\n              \"title\": \"CA Blocks\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"orange\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"20\",\n            \"name\": \"ca-blocks\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| summarize Count = dcount(UserPrincipalName)\",\n              \"size\": 4,\n              \"title\": \"Unique Users\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"green\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"20\",\n            \"name\": \"unique-users\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where RiskLevelDuringSignIn in (\\\"low\\\", \\\"medium\\\", \\\"high\\\")\\n| summarize Count = count()\",\n              \"size\": 4,\n              \"title\": \"Risky Sign-ins\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"magenta\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"20\",\n            \"name\": \"risky-signins-count\"\n          }\n        ]\n      },\n      \"name\": \"overview-tiles\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## Risky Sign-ins\"\n      },\n      \"conditionalVisibility\": {\n        \"parameterName\": \"HasRiskySignins\",\n        \"comparison\": \"isNotEqualTo\",\n        \"value\": \"\"\n      },\n      \"name\": \"risky-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where RiskLevelDuringSignIn in (\\\"low\\\", \\\"medium\\\", \\\"high\\\")\\n| summarize SignInCount = count() by RiskLevelDuringSignIn\\n| order by case(\\n    RiskLevelDuringSignIn == \\\"high\\\", 1,\\n    RiskLevelDuringSignIn == \\\"medium\\\", 2,\\n    RiskLevelDuringSignIn == \\\"low\\\", 3,\\n    4)\",\n              \"size\": 2,\n              \"title\": \"Sign-ins by Risk Level\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"piechart\",\n              \"chartSettings\": {\n                \"seriesLabelSettings\": [\n                  {\n                    \"seriesName\": \"high\",\n                    \"color\": \"redBright\"\n                  },\n                  {\n                    \"seriesName\": \"medium\",\n                    \"color\": \"orange\"\n                  },\n                  {\n                    \"seriesName\": \"low\",\n                    \"color\": \"yellow\"\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"35\",\n            \"name\": \"risk-level-chart\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where RiskLevelDuringSignIn in (\\\"low\\\", \\\"medium\\\", \\\"high\\\")\\n| summarize \\n    SignInCount = count(),\\n    HighRisk = countif(RiskLevelDuringSignIn == \\\"high\\\"),\\n    MediumRisk = countif(RiskLevelDuringSignIn == \\\"medium\\\"),\\n    LowRisk = countif(RiskLevelDuringSignIn == \\\"low\\\"),\\n    LatestSignIn = max(TimeGenerated)\\n    by UserPrincipalName, UserDisplayName\\n| project \\n    UserDisplayName,\\n    UserPrincipalName,\\n    SignInCount,\\n    HighRisk,\\n    MediumRisk,\\n    LowRisk,\\n    LatestSignIn\\n| order by HighRisk desc, MediumRisk desc, SignInCount desc\\n| take 25\",\n              \"size\": 2,\n              \"title\": \"Users with Risky Sign-ins (Top 25)\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"table\",\n              \"gridSettings\": {\n                \"formatters\": [\n                  {\n                    \"columnMatch\": \"HighRisk\",\n                    \"formatter\": 8,\n                    \"formatOptions\": {\n                      \"palette\": \"redBright\"\n                    }\n                  },\n                  {\n                    \"columnMatch\": \"MediumRisk\",\n                    \"formatter\": 8,\n                    \"formatOptions\": {\n                      \"palette\": \"orange\"\n                    }\n                  },\n                  {\n                    \"columnMatch\": \"LowRisk\",\n                    \"formatter\": 8,\n                    \"formatOptions\": {\n                      \"palette\": \"yellow\"\n                    }\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"65\",\n            \"name\": \"risky-users-list\"\n          }\n        ]\n      },\n      \"conditionalVisibility\": {\n        \"parameterName\": \"HasRiskySignins\",\n        \"comparison\": \"isNotEqualTo\",\n        \"value\": \"\"\n      },\n      \"name\": \"risky-signins-group\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## Geographic Analysis\"\n      },\n      \"name\": \"geo-header\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"SigninLogs\\n| extend \\n    Latitude = toreal(LocationDetails.geoCoordinates.latitude),\\n    Longitude = toreal(LocationDetails.geoCoordinates.longitude),\\n    City = tostring(LocationDetails.city),\\n    State = tostring(LocationDetails.state),\\n    Country = tostring(LocationDetails.countryOrRegion)\\n| where isnotempty(Latitude) and isnotempty(Longitude)\\n| summarize \\n    SignInCount = count(),\\n    UniqueUsers = dcount(UserPrincipalName),\\n    FailedCount = countif(ResultType != 0)\\n    by City, State, Country, Latitude, Longitude\\n| project \\n    Location = strcat(City, \\\", \\\", State, \\\", \\\", Country),\\n    City,\\n    Country,\\n    SignInCount,\\n    UniqueUsers,\\n    FailedCount,\\n    Latitude,\\n    Longitude\",\n        \"size\": 0,\n        \"title\": \"Sign-in Locations (City Level)\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"map\",\n        \"mapSettings\": {\n          \"locInfo\": \"LatLong\",\n          \"latitude\": \"Latitude\",\n          \"longitude\": \"Longitude\",\n          \"sizeSettings\": \"SignInCount\",\n          \"sizeAggregation\": \"Sum\",\n          \"labelSettings\": \"City\",\n          \"legendMetric\": \"SignInCount\",\n          \"legendAggregation\": \"Sum\",\n          \"itemColorSettings\": {\n            \"nodeColorField\": \"SignInCount\",\n            \"colorAggregation\": \"Sum\",\n            \"type\": \"heatmap\",\n            \"heatmapPalette\": \"coldHot\"\n          }\n        },\n        \"headingLevel\": 3\n      },\n      \"name\": \"geo-map\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"SigninLogs\\n| extend \\n    City = tostring(LocationDetails.city),\\n    Country = tostring(LocationDetails.countryOrRegion)\\n| summarize \\n    SignInCount = count(),\\n    UniqueUsers = dcount(UserPrincipalName),\\n    FailedCount = countif(ResultType != 0),\\n    SuccessRate = round(100.0 * countif(ResultType == 0) / count(), 1)\\n    by City, Country\\n| order by SignInCount desc\\n| take 15\\n| project \\n    Location = strcat(City, \\\", \\\", Country),\\n    SignInCount,\\n    UniqueUsers,\\n    FailedCount,\\n    SuccessRate = strcat(SuccessRate, \\\"%\\\")\",\n        \"size\": 2,\n        \"title\": \"Top 15 Sign-in Locations\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\",\n        \"gridSettings\": {\n          \"formatters\": [\n            {\n              \"columnMatch\": \"SignInCount\",\n              \"formatter\": 4,\n              \"formatOptions\": {\n                \"palette\": \"blue\"\n              }\n            },\n            {\n              \"columnMatch\": \"FailedCount\",\n              \"formatter\": 8,\n              \"formatOptions\": {\n                \"palette\": \"redBright\"\n              }\n            }\n          ]\n        }\n      },\n      \"name\": \"top-locations-table\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## Failed Sign-ins Analysis\"\n      },\n      \"name\": \"failed-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where ResultType != 0\\n| summarize FailedCount = count() by bin(TimeGenerated, 1h)\\n| order by TimeGenerated asc\",\n              \"size\": 0,\n              \"title\": \"Failed Sign-ins Over Time\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"linechart\",\n              \"chartSettings\": {\n                \"seriesLabelSettings\": [\n                  {\n                    \"seriesName\": \"FailedCount\",\n                    \"color\": \"redBright\"\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"60\",\n            \"name\": \"failed-trend\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"let ErrorCodes = datatable(ResultType: string, Description: string) [\\n    \\\"50126\\\", \\\"Invalid username or password\\\",\\n    \\\"50053\\\", \\\"Account locked\\\",\\n    \\\"50057\\\", \\\"Account disabled\\\",\\n    \\\"50055\\\", \\\"Password expired\\\",\\n    \\\"50074\\\", \\\"MFA required\\\",\\n    \\\"50076\\\", \\\"MFA required (admin policy)\\\",\\n    \\\"53003\\\", \\\"Blocked by CA\\\",\\n    \\\"530032\\\", \\\"Blocked - security default\\\",\\n    \\\"530034\\\", \\\"Blocked - CA location policy\\\",\\n    \\\"50158\\\", \\\"External security challenge not met\\\",\\n    \\\"50140\\\", \\\"Keep me signed in interrupt\\\",\\n    \\\"50144\\\", \\\"Password change required\\\",\\n    \\\"500121\\\", \\\"MFA failed\\\",\\n    \\\"50097\\\", \\\"Device auth required\\\",\\n    \\\"70044\\\", \\\"Session expired\\\"\\n];\\nSigninLogs\\n| where ResultType != 0\\n| extend ResultTypeStr = tostring(ResultType)\\n| summarize Count = count() by ResultTypeStr\\n| join kind=leftouter ErrorCodes on $left.ResultTypeStr == $right.ResultType\\n| project \\n    ErrorCode = ResultTypeStr,\\n    Description = coalesce(Description, \\\"Other/Unknown\\\"),\\n    Count\\n| order by Count desc\\n| take 10\",\n              \"size\": 2,\n              \"title\": \"Top Failure Reasons\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"table\",\n              \"gridSettings\": {\n                \"formatters\": [\n                  {\n                    \"columnMatch\": \"Count\",\n                    \"formatter\": 4,\n                    \"formatOptions\": {\n                      \"palette\": \"redBright\"\n                    }\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"40\",\n            \"name\": \"failure-reasons\"\n          }\n        ]\n      },\n      \"name\": \"failed-group\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"SigninLogs\\n| where ResultType != 0\\n| summarize \\n    FailedCount = count(),\\n    DistinctIPs = dcount(IPAddress),\\n    LatestAttempt = max(TimeGenerated),\\n    TopError = any(ResultType)\\n    by UserPrincipalName, UserDisplayName\\n| order by FailedCount desc\\n| take 20\\n| project\\n    UserDisplayName,\\n    UserPrincipalName,\\n    FailedCount,\\n    DistinctIPs,\\n    LatestAttempt,\\n    TopError\",\n        \"size\": 2,\n        \"title\": \"Users with Most Failed Sign-ins (Top 20)\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\",\n        \"gridSettings\": {\n          \"formatters\": [\n            {\n              \"columnMatch\": \"FailedCount\",\n              \"formatter\": 8,\n              \"formatOptions\": {\n                \"palette\": \"redBright\"\n              }\n            },\n            {\n              \"columnMatch\": \"DistinctIPs\",\n              \"formatter\": 8,\n              \"formatOptions\": {\n                \"palette\": \"orange\"\n              }\n            }\n          ]\n        }\n      },\n      \"name\": \"failed-users\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## Conditional Access\"\n      },\n      \"name\": \"ca-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| summarize Count = count() by ConditionalAccessStatus\\n| extend Status = case(\\n    ConditionalAccessStatus == \\\"success\\\", \\\"Passed\\\",\\n    ConditionalAccessStatus == \\\"failure\\\", \\\"Blocked\\\",\\n    ConditionalAccessStatus == \\\"notApplied\\\", \\\"Not Applied\\\",\\n    ConditionalAccessStatus\\n)\",\n              \"size\": 2,\n              \"title\": \"CA Policy Results\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"piechart\",\n              \"chartSettings\": {\n                \"seriesLabelSettings\": [\n                  {\n                    \"seriesName\": \"Passed\",\n                    \"color\": \"green\"\n                  },\n                  {\n                    \"seriesName\": \"Blocked\",\n                    \"color\": \"redBright\"\n                  },\n                  {\n                    \"seriesName\": \"Not Applied\",\n                    \"color\": \"gray\"\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"35\",\n            \"name\": \"ca-status-pie\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where ConditionalAccessStatus == \\\"failure\\\"\\n| mv-expand CAPolicy = ConditionalAccessPolicies\\n| where CAPolicy.result == \\\"failure\\\"\\n| summarize BlockCount = count() by PolicyName = tostring(CAPolicy.displayName)\\n| order by BlockCount desc\\n| take 10\",\n              \"size\": 2,\n              \"title\": \"Top Blocking CA Policies\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"table\",\n              \"gridSettings\": {\n                \"formatters\": [\n                  {\n                    \"columnMatch\": \"BlockCount\",\n                    \"formatter\": 4,\n                    \"formatOptions\": {\n                      \"palette\": \"orange\"\n                    }\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"65\",\n            \"name\": \"ca-blocking-policies\"\n          }\n        ]\n      },\n      \"name\": \"ca-overview-group\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"SigninLogs\\n| where ConditionalAccessStatus == \\\"failure\\\"\\n| summarize \\n    BlockCount = count(),\\n    LatestBlock = max(TimeGenerated)\\n    by UserPrincipalName, UserDisplayName, AppDisplayName\\n| order by BlockCount desc\\n| take 20\",\n        \"size\": 2,\n        \"title\": \"Users Blocked by CA (Top 20)\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\",\n        \"gridSettings\": {\n          \"formatters\": [\n            {\n              \"columnMatch\": \"BlockCount\",\n              \"formatter\": 8,\n              \"formatOptions\": {\n                \"palette\": \"orange\"\n              }\n            }\n          ]\n        }\n      },\n      \"name\": \"ca-blocked-users\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## Legacy Authentication\"\n      },\n      \"name\": \"legacy-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"let LegacyProtocols = dynamic([\\\"Authenticated SMTP\\\", \\\"Autodiscover\\\", \\\"Exchange ActiveSync\\\", \\\"Exchange Online PowerShell\\\", \\\"Exchange Web Services\\\", \\\"IMAP4\\\", \\\"MAPI Over HTTP\\\", \\\"Offline Address Book\\\", \\\"Outlook Anywhere (RPC over HTTP)\\\", \\\"Other clients\\\", \\\"POP3\\\", \\\"Reporting Web Services\\\"]);\\nSigninLogs\\n| extend IsLegacy = ClientAppUsed in (LegacyProtocols)\\n| where IsLegacy == true\\n| summarize LegacyCount = count() by bin(TimeGenerated, 1d)\\n| order by TimeGenerated asc\",\n              \"size\": 0,\n              \"title\": \"Legacy Auth Usage Over Time\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"linechart\",\n              \"chartSettings\": {\n                \"seriesLabelSettings\": [\n                  {\n                    \"seriesName\": \"LegacyCount\",\n                    \"color\": \"purple\"\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"60\",\n            \"name\": \"legacy-trend\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"let LegacyProtocols = dynamic([\\\"Authenticated SMTP\\\", \\\"Autodiscover\\\", \\\"Exchange ActiveSync\\\", \\\"Exchange Online PowerShell\\\", \\\"Exchange Web Services\\\", \\\"IMAP4\\\", \\\"MAPI Over HTTP\\\", \\\"Offline Address Book\\\", \\\"Outlook Anywhere (RPC over HTTP)\\\", \\\"Other clients\\\", \\\"POP3\\\", \\\"Reporting Web Services\\\"]);\\nSigninLogs\\n| where ClientAppUsed in (LegacyProtocols)\\n| summarize Count = count() by ClientAppUsed\\n| order by Count desc\",\n              \"size\": 2,\n              \"title\": \"Legacy Auth by Protocol\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"piechart\",\n              \"chartSettings\": {\n                \"seriesLabelSettings\": [\n                  {\n                    \"seriesName\": \"IMAP4\",\n                    \"color\": \"purple\"\n                  },\n                  {\n                    \"seriesName\": \"POP3\",\n                    \"color\": \"magenta\"\n                  },\n                  {\n                    \"seriesName\": \"Authenticated SMTP\",\n                    \"color\": \"pink\"\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"40\",\n            \"name\": \"legacy-protocols\"\n          }\n        ]\n      },\n      \"name\": \"legacy-overview-group\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"let LegacyProtocols = dynamic([\\\"Authenticated SMTP\\\", \\\"Autodiscover\\\", \\\"Exchange ActiveSync\\\", \\\"Exchange Online PowerShell\\\", \\\"Exchange Web Services\\\", \\\"IMAP4\\\", \\\"MAPI Over HTTP\\\", \\\"Offline Address Book\\\", \\\"Outlook Anywhere (RPC over HTTP)\\\", \\\"Other clients\\\", \\\"POP3\\\", \\\"Reporting Web Services\\\"]);\\nSigninLogs\\n| where ClientAppUsed in (LegacyProtocols)\\n| summarize \\n    SignInCount = count(),\\n    Protocols = make_set(ClientAppUsed),\\n    LatestUse = max(TimeGenerated)\\n    by UserPrincipalName, UserDisplayName\\n| order by SignInCount desc\\n| take 20\\n| project\\n    UserDisplayName,\\n    UserPrincipalName,\\n    SignInCount,\\n    Protocols,\\n    LatestUse\",\n        \"size\": 2,\n        \"title\": \"Users Using Legacy Auth (Top 20)\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\",\n        \"gridSettings\": {\n          \"formatters\": [\n            {\n              \"columnMatch\": \"SignInCount\",\n              \"formatter\": 8,\n              \"formatOptions\": {\n                \"palette\": \"purple\"\n              }\n            }\n          ]\n        }\n      },\n      \"name\": \"legacy-users\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## MFA Analysis\"\n      },\n      \"name\": \"mfa-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where AuthenticationRequirement == \\\"multiFactorAuthentication\\\"\\n| extend MFAMethod = tostring(MfaDetail.authMethod)\\n| where isnotempty(MFAMethod)\\n| summarize Count = count() by MFAMethod\\n| order by Count desc\",\n              \"size\": 2,\n              \"title\": \"MFA Methods Used\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"piechart\",\n              \"chartSettings\": {\n                \"seriesLabelSettings\": [\n                  {\n                    \"seriesName\": \"PhoneAppNotification\",\n                    \"color\": \"green\"\n                  },\n                  {\n                    \"seriesName\": \"PhoneAppOTP\",\n                    \"color\": \"blue\"\n                  },\n                  {\n                    \"seriesName\": \"OneWaySMS\",\n                    \"color\": \"yellow\"\n                  },\n                  {\n                    \"seriesName\": \"TwoWayVoiceMobile\",\n                    \"color\": \"orange\"\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"40\",\n            \"name\": \"mfa-methods-pie\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| summarize \\n    TotalSignins = count(),\\n    MFARequired = countif(AuthenticationRequirement == \\\"multiFactorAuthentication\\\"),\\n    SingleFactor = countif(AuthenticationRequirement == \\\"singleFactorAuthentication\\\")\\n| extend \\n    MFAPercent = round(100.0 * MFARequired / TotalSignins, 1),\\n    SinglePercent = round(100.0 * SingleFactor / TotalSignins, 1)\\n| project \\n    [\\\"MFA Required\\\"] = strcat(MFARequired, \\\" (\\\", MFAPercent, \\\"%)\\\"),\\n    [\\\"Single Factor\\\"] = strcat(SingleFactor, \\\" (\\\", SinglePercent, \\\"%)\\\"),\\n    [\\\"Total\\\"] = TotalSignins\",\n              \"size\": 4,\n              \"title\": \"MFA vs Single Factor\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"showBorder\": true\n              }\n            },\n            \"customWidth\": \"60\",\n            \"name\": \"mfa-ratio\"\n          }\n        ]\n      },\n      \"name\": \"mfa-overview-group\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"SigninLogs\\n| where AuthenticationRequirement == \\\"singleFactorAuthentication\\\" and ResultType == 0\\n| summarize \\n    SingleFactorCount = count(),\\n    Apps = make_set(AppDisplayName, 5),\\n    LatestSignIn = max(TimeGenerated)\\n    by UserPrincipalName, UserDisplayName\\n| order by SingleFactorCount desc\\n| take 20\",\n        \"size\": 2,\n        \"title\": \"Users with Single Factor Sign-ins (Successful)\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\",\n        \"gridSettings\": {\n          \"formatters\": [\n            {\n              \"columnMatch\": \"SingleFactorCount\",\n              \"formatter\": 8,\n              \"formatOptions\": {\n                \"palette\": \"yellow\"\n              }\n            }\n          ]\n        }\n      },\n      \"name\": \"single-factor-users\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## Device Compliance\"\n      },\n      \"name\": \"device-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| extend IsManaged = tostring(DeviceDetail.isManaged)\\n| extend DeviceStatus = case(\\n    IsManaged == \\\"true\\\", \\\"Managed\\\",\\n    IsManaged == \\\"false\\\", \\\"Unmanaged\\\",\\n    \\\"Unknown\\\"\\n)\\n| summarize Count = count() by DeviceStatus\",\n              \"size\": 2,\n              \"title\": \"Managed vs Unmanaged\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"piechart\",\n              \"chartSettings\": {\n                \"seriesLabelSettings\": [\n                  {\n                    \"seriesName\": \"Managed\",\n                    \"color\": \"green\"\n                  },\n                  {\n                    \"seriesName\": \"Unmanaged\",\n                    \"color\": \"redBright\"\n                  },\n                  {\n                    \"seriesName\": \"Unknown\",\n                    \"color\": \"gray\"\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"33\",\n            \"name\": \"managed-pie\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| extend IsCompliant = tostring(DeviceDetail.isCompliant)\\n| extend ComplianceStatus = case(\\n    IsCompliant == \\\"true\\\", \\\"Compliant\\\",\\n    IsCompliant == \\\"false\\\", \\\"Non-Compliant\\\",\\n    \\\"Unknown/Unregistered\\\"\\n)\\n| summarize Count = count() by ComplianceStatus\",\n              \"size\": 2,\n              \"title\": \"Device Compliance Status\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"piechart\",\n              \"chartSettings\": {\n                \"seriesLabelSettings\": [\n                  {\n                    \"seriesName\": \"Compliant\",\n                    \"color\": \"green\"\n                  },\n                  {\n                    \"seriesName\": \"Non-Compliant\",\n                    \"color\": \"redBright\"\n                  },\n                  {\n                    \"seriesName\": \"Unknown/Unregistered\",\n                    \"color\": \"gray\"\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"33\",\n            \"name\": \"compliance-pie\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| extend TrustType = tostring(DeviceDetail.trustType)\\n| extend JoinType = case(\\n    TrustType == \\\"AzureAd\\\", \\\"Azure AD Joined\\\",\\n    TrustType == \\\"Hybrid\\\", \\\"Hybrid Joined\\\",\\n    TrustType == \\\"Workplace\\\", \\\"Workplace Joined\\\",\\n    \\\"Unregistered\\\"\\n)\\n| summarize Count = count() by JoinType\",\n              \"size\": 2,\n              \"title\": \"Device Join Type\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"piechart\",\n              \"chartSettings\": {\n                \"seriesLabelSettings\": [\n                  {\n                    \"seriesName\": \"Azure AD Joined\",\n                    \"color\": \"blue\"\n                  },\n                  {\n                    \"seriesName\": \"Hybrid Joined\",\n                    \"color\": \"teal\"\n                  },\n                  {\n                    \"seriesName\": \"Workplace Joined\",\n                    \"color\": \"orange\"\n                  },\n                  {\n                    \"seriesName\": \"Unregistered\",\n                    \"color\": \"gray\"\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"33\",\n            \"name\": \"join-type-pie\"\n          }\n        ]\n      },\n      \"name\": \"device-overview-group\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"SigninLogs\\n| where DeviceDetail.isManaged != true or isempty(DeviceDetail.isManaged)\\n| summarize \\n    SignInCount = count(),\\n    Devices = dcount(tostring(DeviceDetail.deviceId)),\\n    LatestSignIn = max(TimeGenerated)\\n    by UserPrincipalName, UserDisplayName\\n| order by SignInCount desc\\n| take 20\\n| project\\n    UserDisplayName,\\n    UserPrincipalName,\\n    SignInCount,\\n    Devices,\\n    LatestSignIn\",\n        \"size\": 2,\n        \"title\": \"Sign-ins from Unmanaged Devices (Top 20)\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\",\n        \"gridSettings\": {\n          \"formatters\": [\n            {\n              \"columnMatch\": \"SignInCount\",\n              \"formatter\": 8,\n              \"formatOptions\": {\n                \"palette\": \"redBright\"\n              }\n            }\n          ]\n        }\n      },\n      \"name\": \"unmanaged-users\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"SigninLogs\\n| extend OS = tostring(DeviceDetail.operatingSystem)\\n| where isnotempty(OS)\\n| summarize Count = count() by OS\\n| order by Count desc\\n| take 10\",\n        \"size\": 2,\n        \"title\": \"Sign-ins by OS\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"barchart\",\n        \"chartSettings\": {\n          \"xAxis\": \"OS\",\n          \"yAxis\": [\n            \"Count\"\n          ],\n          \"seriesLabelSettings\": [\n            {\n              \"seriesName\": \"Count\",\n              \"color\": \"blue\"\n            }\n          ]\n        }\n      },\n      \"name\": \"os-breakdown\"\n    }\n  ],\n  \"$schema\": \"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"\n}\n</code></pre>"},{"location":"workbooks/user%20compromise%20investigation/","title":"User Compromise Investigation","text":""},{"location":"workbooks/user%20compromise%20investigation/#user-compromise-investigation","title":"User Compromise Investigation","text":""},{"location":"workbooks/user%20compromise%20investigation/#template","title":"Template","text":"<pre><code>{\n  \"version\": \"Notebook/1.0\",\n  \"items\": [\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"# User Compromise Investigation\\n\\nRapid triage workbook for investigating suspected user compromise. Surfaces sign-in patterns, identity changes, app consents, and M365 activity for a single user in one view.\\n\\n---\"\n      },\n      \"name\": \"title\"\n    },\n    {\n      \"type\": 9,\n      \"content\": {\n        \"version\": \"KqlParameterItem/1.0\",\n        \"parameters\": [\n          {\n            \"version\": \"KqlParameterItem/1.0\",\n            \"name\": \"SelectedUser\",\n            \"type\": 2,\n            \"isRequired\": true,\n            \"query\": \"SigninLogs\\n| where TimeGenerated &gt; ago(30d)\\n| summarize by UserPrincipalName, UserDisplayName\\n| order by UserDisplayName asc\\n| project Value = UserPrincipalName, Label = strcat(UserDisplayName, \\\" (\\\", UserPrincipalName, \\\")\\\")\",\n            \"queryType\": 0,\n            \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n            \"typeSettings\": {\n              \"showDefault\": false\n            },\n            \"label\": \"User\",\n            \"value\": \"exp-emil.dosen@peps.org\"\n          },\n          {\n            \"version\": \"KqlParameterItem/1.0\",\n            \"name\": \"TimeRange\",\n            \"type\": 4,\n            \"isRequired\": true,\n            \"typeSettings\": {\n              \"selectableValues\": [\n                {\n                  \"durationMs\": 86400000\n                },\n                {\n                  \"durationMs\": 259200000\n                },\n                {\n                  \"durationMs\": 604800000\n                },\n                {\n                  \"durationMs\": 1209600000\n                },\n                {\n                  \"durationMs\": 2592000000\n                }\n              ],\n              \"allowCustom\": true\n            },\n            \"value\": {\n              \"durationMs\": 604800000\n            },\n            \"label\": \"Time Range\"\n          }\n        ],\n        \"style\": \"pills\"\n      },\n      \"name\": \"parameters\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"## Overview\"\n      },\n      \"name\": \"overview-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where UserPrincipalName == \\\"{SelectedUser}\\\"\\n| summarize Count = count()\",\n              \"size\": 4,\n              \"title\": \"Total Sign-ins\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"blue\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"20\",\n            \"name\": \"total-signins\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where UserPrincipalName == \\\"{SelectedUser}\\\"\\n| where ResultType != 0\\n| summarize Count = count()\",\n              \"size\": 4,\n              \"title\": \"Failed Sign-ins\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"redBright\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"20\",\n            \"name\": \"failed-signins\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where UserPrincipalName == \\\"{SelectedUser}\\\"\\n| summarize Count = dcount(IPAddress)\",\n              \"size\": 4,\n              \"title\": \"Unique IPs\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"orange\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"20\",\n            \"name\": \"unique-ips\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where UserPrincipalName == \\\"{SelectedUser}\\\"\\n| extend City = tostring(LocationDetails.city)\\n| summarize Count = dcount(City)\",\n              \"size\": 4,\n              \"title\": \"Unique Locations\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"purple\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"20\",\n            \"name\": \"unique-locations\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where UserPrincipalName == \\\"{SelectedUser}\\\"\\n| where RiskLevelDuringSignIn in (\\\"low\\\", \\\"medium\\\", \\\"high\\\")\\n| summarize Count = count()\",\n              \"size\": 4,\n              \"title\": \"Risky Sign-ins\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"tiles\",\n              \"tileSettings\": {\n                \"titleContent\": {\n                  \"columnMatch\": \"Count\",\n                  \"formatter\": 12,\n                  \"formatOptions\": {\n                    \"palette\": \"magenta\"\n                  }\n                },\n                \"showBorder\": false\n              }\n            },\n            \"customWidth\": \"20\",\n            \"name\": \"risky-signins\"\n          }\n        ]\n      },\n      \"name\": \"overview-tiles\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## Sign-in Analysis\"\n      },\n      \"name\": \"signin-header\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"SigninLogs\\n| where UserPrincipalName == \\\"{SelectedUser}\\\"\\n| extend \\n    Latitude = toreal(LocationDetails.geoCoordinates.latitude),\\n    Longitude = toreal(LocationDetails.geoCoordinates.longitude),\\n    City = tostring(LocationDetails.city),\\n    Country = tostring(LocationDetails.countryOrRegion)\\n| where isnotempty(Latitude) and isnotempty(Longitude)\\n| summarize \\n    SignInCount = count(),\\n    FailedCount = countif(ResultType != 0),\\n    LatestSignIn = max(TimeGenerated)\\n    by City, Country, Latitude, Longitude\\n| project \\n    Location = strcat(City, \\\", \\\", Country),\\n    SignInCount,\\n    FailedCount,\\n    LatestSignIn,\\n    Latitude,\\n    Longitude\",\n        \"size\": 0,\n        \"title\": \"Sign-in Locations\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"map\",\n        \"mapSettings\": {\n          \"locInfo\": \"LatLong\",\n          \"latitude\": \"Latitude\",\n          \"longitude\": \"Longitude\",\n          \"sizeSettings\": \"SignInCount\",\n          \"sizeAggregation\": \"Sum\",\n          \"labelSettings\": \"Location\",\n          \"legendMetric\": \"SignInCount\",\n          \"legendAggregation\": \"Sum\",\n          \"zoom\": 2,\n          \"itemColorSettings\": {\n            \"nodeColorField\": \"FailedCount\",\n            \"colorAggregation\": \"Sum\",\n            \"type\": \"heatmap\",\n            \"heatmapPalette\": \"coldHot\"\n          }\n        }\n      },\n      \"name\": \"signin-map\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where UserPrincipalName == \\\"{SelectedUser}\\\"\\n| summarize \\n    Success = countif(ResultType == 0),\\n    Failed = countif(ResultType != 0)\\n    by bin(TimeGenerated, 1h)\\n| order by TimeGenerated asc\",\n              \"size\": 0,\n              \"title\": \"Sign-in Timeline\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"linechart\",\n              \"chartSettings\": {\n                \"seriesLabelSettings\": [\n                  {\n                    \"seriesName\": \"Success\",\n                    \"color\": \"green\"\n                  },\n                  {\n                    \"seriesName\": \"Failed\",\n                    \"color\": \"redBright\"\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"70\",\n            \"name\": \"signin-timeline\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"SigninLogs\\n| where UserPrincipalName == \\\"{SelectedUser}\\\"\\n| extend IsManaged = tostring(DeviceDetail.isManaged)\\n| extend DeviceStatus = case(\\n    IsManaged == \\\"true\\\", \\\"Managed\\\",\\n    IsManaged == \\\"false\\\", \\\"Unmanaged\\\",\\n    \\\"Unknown\\\"\\n)\\n| summarize Count = count() by DeviceStatus\",\n              \"size\": 2,\n              \"title\": \"Device Management Status\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"piechart\",\n              \"chartSettings\": {\n                \"seriesLabelSettings\": [\n                  {\n                    \"seriesName\": \"Managed\",\n                    \"color\": \"green\"\n                  },\n                  {\n                    \"seriesName\": \"Unmanaged\",\n                    \"color\": \"redBright\"\n                  },\n                  {\n                    \"seriesName\": \"Unknown\",\n                    \"color\": \"gray\"\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"30\",\n            \"name\": \"device-status-pie\"\n          }\n        ]\n      },\n      \"name\": \"signin-charts-group\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"SigninLogs\\n| where UserPrincipalName == \\\"{SelectedUser}\\\"\\n| extend \\n    City = tostring(LocationDetails.city),\\n    Country = tostring(LocationDetails.countryOrRegion),\\n    OS = tostring(DeviceDetail.operatingSystem),\\n    Browser = tostring(DeviceDetail.browser),\\n    IsManaged = iff(tostring(DeviceDetail.isManaged) == \\\"true\\\", \\\"Yes\\\", \\\"No\\\")\\n| project \\n    TimeGenerated,\\n    IPAddress,\\n    Location = strcat(City, \\\", \\\", Country),\\n    AppDisplayName,\\n    OS,\\n    Browser,\\n    IsManaged,\\n    ConditionalAccessStatus,\\n    ResultType,\\n    ResultDescription,\\n    RiskLevelDuringSignIn\\n| order by TimeGenerated desc\",\n        \"size\": 2,\n        \"title\": \"Sign-in Details\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\",\n        \"gridSettings\": {\n          \"formatters\": [\n            {\n              \"columnMatch\": \"ResultType\",\n              \"formatter\": 18,\n              \"formatOptions\": {\n                \"thresholdsOptions\": \"icons\",\n                \"thresholdsGrid\": [\n                  {\n                    \"operator\": \"==\",\n                    \"thresholdValue\": \"0\",\n                    \"representation\": \"success\",\n                    \"text\": \"{0}\"\n                  },\n                  {\n                    \"operator\": \"Default\",\n                    \"representation\": \"error\",\n                    \"text\": \"{0}\"\n                  }\n                ]\n              }\n            },\n            {\n              \"columnMatch\": \"RiskLevelDuringSignIn\",\n              \"formatter\": 18,\n              \"formatOptions\": {\n                \"thresholdsOptions\": \"colors\",\n                \"thresholdsGrid\": [\n                  {\n                    \"operator\": \"==\",\n                    \"thresholdValue\": \"high\",\n                    \"representation\": \"redBright\",\n                    \"text\": \"{0}\"\n                  },\n                  {\n                    \"operator\": \"==\",\n                    \"thresholdValue\": \"medium\",\n                    \"representation\": \"orange\",\n                    \"text\": \"{0}\"\n                  },\n                  {\n                    \"operator\": \"==\",\n                    \"thresholdValue\": \"low\",\n                    \"representation\": \"yellow\",\n                    \"text\": \"{0}\"\n                  },\n                  {\n                    \"operator\": \"Default\",\n                    \"text\": \"{0}\"\n                  }\n                ]\n              }\n            }\n          ]\n        }\n      },\n      \"name\": \"signin-details\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## Red Flags\"\n      },\n      \"name\": \"redflags-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"let UserSignins = SigninLogs\\n| where UserPrincipalName == \\\"{SelectedUser}\\\"\\n| where ResultType == 0\\n| extend \\n    Latitude = toreal(LocationDetails.geoCoordinates.latitude),\\n    Longitude = toreal(LocationDetails.geoCoordinates.longitude),\\n    City = tostring(LocationDetails.city),\\n    Country = tostring(LocationDetails.countryOrRegion)\\n| where isnotempty(Latitude) and isnotempty(Longitude)\\n| project TimeGenerated, City, Country, Latitude, Longitude, IPAddress;\\nUserSignins\\n| order by TimeGenerated asc\\n| extend PrevTime = prev(TimeGenerated), PrevLat = prev(Latitude), PrevLon = prev(Longitude), PrevCity = prev(City)\\n| where isnotempty(PrevTime)\\n| extend \\n    TimeDiffMins = datetime_diff('minute', TimeGenerated, PrevTime),\\n    DistanceKm = geo_distance_2points(Longitude, Latitude, PrevLon, PrevLat) / 1000\\n| where TimeDiffMins &gt; 0\\n| extend SpeedKmh = DistanceKm / (TimeDiffMins / 60.0)\\n| where SpeedKmh &gt; 500 and DistanceKm &gt; 100\\n| project \\n    Time = TimeGenerated,\\n    FromCity = PrevCity,\\n    ToCity = City,\\n    TimeDiffMins = round(TimeDiffMins, 0),\\n    DistanceKm = round(DistanceKm, 0),\\n    SpeedKmh = round(SpeedKmh, 0),\\n    IPAddress\\n| order by Time desc\",\n              \"size\": 2,\n              \"title\": \"Impossible Travel (&gt;500 km/h)\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"table\",\n              \"gridSettings\": {\n                \"formatters\": [\n                  {\n                    \"columnMatch\": \"SpeedKmh\",\n                    \"formatter\": 8,\n                    \"formatOptions\": {\n                      \"palette\": \"redBright\"\n                    }\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"60\",\n            \"name\": \"impossible-travel\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"let HistoricalLocations = SigninLogs\\n| where UserPrincipalName == \\\"{SelectedUser}\\\"\\n| where TimeGenerated between (ago(30d) .. ago({TimeRange:seconds}s))\\n| extend City = tostring(LocationDetails.city), Country = tostring(LocationDetails.countryOrRegion)\\n| where isnotempty(City)\\n| distinct City, Country;\\nSigninLogs\\n| where UserPrincipalName == \\\"{SelectedUser}\\\"\\n| extend City = tostring(LocationDetails.city), Country = tostring(LocationDetails.countryOrRegion)\\n| where isnotempty(City)\\n| summarize \\n    SignInCount = count(),\\n    FirstSeen = min(TimeGenerated),\\n    LatestSignIn = max(TimeGenerated)\\n    by City, Country\\n| join kind=leftanti HistoricalLocations on City, Country\\n| project \\n    Location = strcat(City, \\\", \\\", Country),\\n    SignInCount,\\n    FirstSeen,\\n    LatestSignIn\\n| order by FirstSeen desc\",\n              \"size\": 2,\n              \"title\": \"New Locations (not seen in prior 30d)\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"table\",\n              \"gridSettings\": {\n                \"formatters\": [\n                  {\n                    \"columnMatch\": \"SignInCount\",\n                    \"formatter\": 8,\n                    \"formatOptions\": {\n                      \"palette\": \"orange\"\n                    }\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"40\",\n            \"name\": \"new-locations\"\n          }\n        ]\n      },\n      \"name\": \"redflags-group\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## Identity Changes\"\n      },\n      \"name\": \"identity-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"AuditLogs\\n| where OperationName has_any (\\\"User registered security info\\\", \\\"User registered all required security info\\\", \\\"Admin registered security info\\\", \\\"User deleted security info\\\", \\\"Admin deleted security info\\\")\\n| extend UPN = tostring(TargetResources[0].userPrincipalName)\\n| where UPN == \\\"{SelectedUser}\\\"\\n| extend \\n    Method = tostring(AdditionalDetails[0].value),\\n    InitiatedBy = coalesce(\\n        tostring(InitiatedBy.user.userPrincipalName),\\n        tostring(InitiatedBy.app.displayName),\\n        \\\"Unknown\\\"\\n    )\\n| project \\n    TimeGenerated,\\n    OperationName,\\n    Method,\\n    InitiatedBy,\\n    Result\\n| order by TimeGenerated desc\",\n              \"size\": 2,\n              \"title\": \"MFA/Security Info Changes\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"table\",\n              \"gridSettings\": {\n                \"formatters\": [\n                  {\n                    \"columnMatch\": \"OperationName\",\n                    \"formatter\": 18,\n                    \"formatOptions\": {\n                      \"thresholdsOptions\": \"colors\",\n                      \"thresholdsGrid\": [\n                        {\n                          \"operator\": \"contains\",\n                          \"thresholdValue\": \"deleted\",\n                          \"representation\": \"redBright\",\n                          \"text\": \"{0}\"\n                        },\n                        {\n                          \"operator\": \"Default\",\n                          \"text\": \"{0}\"\n                        }\n                      ]\n                    }\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"50\",\n            \"name\": \"mfa-changes\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"AuditLogs\\n| where OperationName has_any (\\\"Change user password\\\", \\\"Reset user password\\\", \\\"Change password (self-service)\\\", \\\"Reset password (self-service)\\\", \\\"Reset password (by admin)\\\")\\n| extend UPN = tostring(TargetResources[0].userPrincipalName)\\n| where UPN == \\\"{SelectedUser}\\\"\\n| extend \\n    InitiatedBy = coalesce(\\n        tostring(InitiatedBy.user.userPrincipalName),\\n        tostring(InitiatedBy.app.displayName),\\n        \\\"Unknown\\\"\\n    )\\n| project \\n    TimeGenerated,\\n    OperationName,\\n    InitiatedBy,\\n    Result\\n| order by TimeGenerated desc\",\n              \"size\": 2,\n              \"title\": \"Password Changes\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"table\"\n            },\n            \"customWidth\": \"50\",\n            \"name\": \"password-changes\"\n          }\n        ]\n      },\n      \"name\": \"identity-group\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## App Consent\"\n      },\n      \"name\": \"consent-header\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"AuditLogs\\n| where OperationName == \\\"Consent to application\\\"\\n| extend UPN = tostring(InitiatedBy.user.userPrincipalName)\\n| where UPN == \\\"{SelectedUser}\\\"\\n| extend \\n    AppName = tostring(TargetResources[0].displayName),\\n    AppId = tostring(TargetResources[0].id)\\n| mv-expand ModifiedProp = TargetResources[0].modifiedProperties\\n| where tostring(ModifiedProp.displayName) == \\\"ConsentContext.IsAdminConsent\\\" or tostring(ModifiedProp.displayName) == \\\"ConsentAction.Permissions\\\"\\n| extend \\n    PropName = tostring(ModifiedProp.displayName),\\n    PropValue = tostring(ModifiedProp.newValue)\\n| summarize \\n    Permissions = make_set_if(PropValue, PropName == \\\"ConsentAction.Permissions\\\"),\\n    IsAdminConsent = make_set_if(PropValue, PropName == \\\"ConsentContext.IsAdminConsent\\\")\\n    by TimeGenerated, AppName, AppId, CorrelationId\\n| project \\n    TimeGenerated,\\n    AppName,\\n    Permissions = tostring(Permissions[0]),\\n    IsAdminConsent = tostring(IsAdminConsent[0])\\n| order by TimeGenerated desc\",\n        \"size\": 2,\n        \"title\": \"OAuth App Consents by User\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\"\n      },\n      \"name\": \"app-consent\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## Email Activity\"\n      },\n      \"name\": \"email-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"OfficeActivity\\n| where UserId == \\\"{SelectedUser}\\\"\\n| where Operation in (\\\"New-InboxRule\\\", \\\"Set-InboxRule\\\", \\\"Enable-InboxRule\\\")\\n| extend Parameters = parse_json(Parameters)\\n| extend \\n    RuleName = tostring(Parameters[0].Value),\\n    RuleDetails = tostring(Parameters)\\n| project \\n    TimeGenerated,\\n    Operation,\\n    RuleName,\\n    RuleDetails,\\n    ClientIP\\n| order by TimeGenerated desc\",\n              \"size\": 2,\n              \"title\": \"Inbox Rules Created/Modified\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"table\",\n              \"gridSettings\": {\n                \"formatters\": [\n                  {\n                    \"columnMatch\": \"Operation\",\n                    \"formatter\": 18,\n                    \"formatOptions\": {\n                      \"thresholdsOptions\": \"colors\",\n                      \"thresholdsGrid\": [\n                        {\n                          \"operator\": \"==\",\n                          \"thresholdValue\": \"New-InboxRule\",\n                          \"representation\": \"orange\",\n                          \"text\": \"{0}\"\n                        },\n                        {\n                          \"operator\": \"Default\",\n                          \"text\": \"{0}\"\n                        }\n                      ]\n                    }\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"50\",\n            \"name\": \"inbox-rules\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"OfficeActivity\\n| where UserId == \\\"{SelectedUser}\\\"\\n| where Operation in (\\\"Set-Mailbox\\\", \\\"Add-MailboxPermission\\\", \\\"Add-RecipientPermission\\\", \\\"Set-MailboxFolderPermission\\\")\\n| extend Parameters = parse_json(Parameters)\\n| project \\n    TimeGenerated,\\n    Operation,\\n    Parameters = tostring(Parameters),\\n    ClientIP\\n| order by TimeGenerated desc\",\n              \"size\": 2,\n              \"title\": \"Mailbox Permissions/Forwarding\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"table\"\n            },\n            \"customWidth\": \"50\",\n            \"name\": \"mailbox-permissions\"\n          }\n        ]\n      },\n      \"name\": \"email-group\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## SharePoint/OneDrive Activity\"\n      },\n      \"name\": \"sharepoint-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"OfficeActivity\\n| where UserId == \\\"{SelectedUser}\\\"\\n| where OfficeWorkload in (\\\"SharePoint\\\", \\\"OneDrive\\\")\\n| where Operation == \\\"FileDownloaded\\\"\\n| summarize DownloadCount = count() by bin(TimeGenerated, 1h)\\n| order by TimeGenerated asc\",\n              \"size\": 0,\n              \"title\": \"File Download Volume\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"linechart\",\n              \"chartSettings\": {\n                \"seriesLabelSettings\": [\n                  {\n                    \"seriesName\": \"DownloadCount\",\n                    \"color\": \"blue\"\n                  }\n                ]\n              }\n            },\n            \"customWidth\": \"50\",\n            \"name\": \"download-trend\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"OfficeActivity\\n| where UserId == \\\"{SelectedUser}\\\"\\n| where OfficeWorkload in (\\\"SharePoint\\\", \\\"OneDrive\\\")\\n| where Operation in (\\\"SharingSet\\\", \\\"AddedToSecureLink\\\", \\\"AnonymousLinkCreated\\\", \\\"SecureLinkCreated\\\", \\\"SharingInvitationCreated\\\")\\n| project \\n    TimeGenerated,\\n    Operation,\\n    SourceFileName,\\n    Site_Url,\\n    TargetUserOrGroupName,\\n    ClientIP\\n| order by TimeGenerated desc\",\n              \"size\": 2,\n              \"title\": \"External Sharing Events\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"table\"\n            },\n            \"customWidth\": \"50\",\n            \"name\": \"external-sharing\"\n          }\n        ]\n      },\n      \"name\": \"sharepoint-group\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"OfficeActivity\\n| where UserId == \\\"{SelectedUser}\\\"\\n| where OfficeWorkload in (\\\"SharePoint\\\", \\\"OneDrive\\\")\\n| where Operation == \\\"FileDownloaded\\\"\\n| project \\n    TimeGenerated,\\n    SourceFileName,\\n    SourceRelativeUrl,\\n    ClientIP,\\n    UserAgent\\n| order by TimeGenerated desc\\n| take 50\",\n        \"size\": 2,\n        \"title\": \"Recent File Downloads (last 50)\",\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\"\n      },\n      \"name\": \"recent-downloads\"\n    },\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"---\\n## Teams Activity\"\n      },\n      \"name\": \"teams-header\"\n    },\n    {\n      \"type\": 12,\n      \"content\": {\n        \"version\": \"NotebookGroup/1.0\",\n        \"groupType\": \"editable\",\n        \"items\": [\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"OfficeActivity\\n| where UserId == \\\"{SelectedUser}\\\"\\n| where OfficeWorkload == \\\"MicrosoftTeams\\\"\\n| where Operation in (\\\"FileDownloaded\\\", \\\"FileUploaded\\\")\\n| project \\n    TimeGenerated,\\n    Operation,\\n    SourceFileName,\\n    ClientIP\\n| order by TimeGenerated desc\\n| take 25\",\n              \"size\": 2,\n              \"title\": \"Teams File Activity\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"table\"\n            },\n            \"customWidth\": \"50\",\n            \"name\": \"teams-files\"\n          },\n          {\n            \"type\": 3,\n            \"content\": {\n              \"version\": \"KqlItem/1.0\",\n              \"query\": \"OfficeActivity\\n| where UserId == \\\"{SelectedUser}\\\"\\n| where OfficeWorkload == \\\"MicrosoftTeams\\\"\\n| where Operation in (\\\"MemberAdded\\\", \\\"MemberRoleChanged\\\")\\n| extend \\n    Members = tostring(Members),\\n    TeamName = tostring(TeamName)\\n| project \\n    TimeGenerated,\\n    Operation,\\n    TeamName,\\n    Members,\\n    ClientIP\\n| order by TimeGenerated desc\",\n              \"size\": 2,\n              \"title\": \"Teams Membership Changes\",\n              \"timeContextFromParameter\": \"TimeRange\",\n              \"queryType\": 0,\n              \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n              \"visualization\": \"table\"\n            },\n            \"customWidth\": \"50\",\n            \"name\": \"teams-membership\"\n          }\n        ]\n      },\n      \"name\": \"teams-group\"\n    }\n  ],\n  \"$schema\": \"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"\n}\n</code></pre>"}]}